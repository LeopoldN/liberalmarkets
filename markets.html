<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Liberal Markets — Minimal Finance Notes</title>
  <link rel="icon" type="image/svg+xml" href="assets/liberalmarketslogo.svg">
  <meta name="description" content="Minimalist finance blog with wireframe iconography and calm, earthy palette." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="styles.css?v=2" />
  <style>
    /* Heatmap: same “wireframe card” vibe, just… colored by reality */
    .hmSection {
      margin-top: 18px;
      padding: 18px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.28);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      backdrop-filter: blur(6px);
    }
    .hmHead {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }
    .hmKicker {
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      opacity: .75;
    }
    .hmTitle {
      margin: 6px 0 6px;
      font-size: 22px;
      line-height: 1.15;
    }
    .hmSub {
      margin: 0;
      max-width: 70ch;
    }
    .hmActions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .hmStamp {
      font-size: 12px;
    }
    .hmGrid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 1100px) {
      .hmGrid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (max-width: 720px) {
      .hmGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .hmHead { flex-direction: column; }
      .hmActions { justify-content: flex-start; }
    }
    .hmTile {
      position: relative;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.35);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
      cursor: pointer;
      text-align: left;
      min-height: 78px;
      display: grid;
      gap: 4px;
      transition: transform .08s ease, filter .08s ease;
    }
    .hmTile:hover { transform: translateY(-1px); filter: contrast(1.03); }
    .hmSym {
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: .8;
    }
    .hmName {
      font-size: 13px;
      line-height: 1.2;
      opacity: .95;
    }
    .hmNums {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-top: 2px;
    }
    .hmPct {
      font-variant-numeric: tabular-nums;
      font-weight: 650;
    }
    .hmPx {
      font-variant-numeric: tabular-nums;
      opacity: .85;
      font-size: 12px;
    }
    .hmTag {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 11px;
      opacity: .75;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.25);
    }

    /* Color bands (subtle, not Vegas). */
    .hmDn3 { background: rgba(180, 65, 65, .36); }
    .hmDn2 { background: rgba(180, 65, 65, .26); }
    .hmDn1 { background: rgba(180, 65, 65, .16); }
    .hmFlat { background: rgba(0, 0, 0, .05); }
    .hmUp1 { background: rgba(88, 129, 87, .16); }
    .hmUp2 { background: rgba(88, 129, 87, .26); }
    .hmUp3 { background: rgba(88, 129, 87, .36); }

    .hmLegend {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      opacity: .85;
    }
    .hmSwatch {
      width: 14px;
      height: 10px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,.10);
      display: inline-block;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <a class="skip" href="#main">Skip to content</a>

  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <!-- Liberal Markets logo -->
        <svg viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg">
        <path d="m655.45 328.74v77.062-0.046875c0 9.375-7.5469 16.969-16.922 16.969h-77.062c-4.5 0-8.8125-1.7812-11.953-4.9688-3.1875-3.1875-4.9688-7.5-4.9688-12v-77.016c0-4.5 1.7812-8.8125 4.9688-12 3.1406-3.1875 7.4531-4.9688 11.953-4.9688h77.062c9.375 0 16.922 7.5938 16.922 16.969zm-279.94 0v77.062-0.046875c0 4.5-1.7812 8.8125-4.9688 12-3.1406 3.1875-7.4531 4.9688-11.953 4.9688h-78.656c-4.4531 0-8.7656-1.7812-11.953-4.9688s-4.9688-7.5-4.9219-12v-77.016c-0.046875-4.5 1.7344-8.8125 4.9219-12s7.5-4.9688 11.953-4.9688h78.656c4.5 0 8.8125 1.7812 11.953 4.9688 3.1875 3.1875 4.9688 7.5 4.9688 12zm488.29-99.094v-78.656c0-4.5 1.7812-8.7656 4.9219-11.953 3.1875-3.1875 7.5-4.9688 12-4.9688h215.44c9.375 0 16.922 7.5938 16.922 16.922v898.03c0 9.3281-7.5469 16.922-16.922 16.922h-215.44c-4.5 0-8.8125-1.7812-12-4.9688-3.1406-3.1875-4.9219-7.4531-4.9219-11.953v-77.016c0-9.3281 7.5469-16.922 16.922-16.922h119.91v-708.52h-119.91c-9.375 0-16.922-7.5938-16.922-16.922zm-664.45 725.39v-708.47h119.91c9.375 0 16.922-7.5938 16.922-16.922v-78.656c0-4.5-1.7812-8.7656-4.9219-11.953-3.1875-3.1875-7.5-4.9688-12-4.9688h-215.44c-9.375 0-16.922 7.5938-16.922 16.922v898.03c0 9.3281 7.5469 16.922 16.922 16.922h215.44c4.5 0 8.8125-1.7812 12-4.9688 3.1406-3.1875 4.9219-7.4531 4.9219-11.953v-77.016c0-9.3281-7.5469-16.922-16.922-16.922zm737.58-160.78 0.046875-0.046875c0-9.3281-7.5938-16.922-16.922-16.922h-78.656c-9.3281 0-16.922 7.5938-16.922 16.922v78.609c0 9.375 7.5938 16.922 16.922 16.969h78.656c9.3281 0 16.922-7.5938 16.922-16.969v-78.562zm-281.53 0v78.609l0.046875-0.046875c0 9.375-7.5469 16.969-16.922 16.969h-77.062c-4.5 0-8.8125-1.7812-11.953-4.9688-3.1875-3.1875-4.9688-7.5-4.9688-12v-78.562c0-4.5 1.7812-8.8125 4.9688-12 3.1406-3.1875 7.4531-4.9688 11.953-4.9688h77.062c9.375 0 16.922 7.5938 16.922 16.969zm-279.94 0v78.609l0.046875-0.046875c0 4.5-1.7812 8.8125-4.9688 12-3.1406 3.1875-7.4531 4.9688-11.953 4.9688h-78.656c-4.4531 0-8.7656-1.7812-11.953-4.9688s-4.9688-7.5-4.9219-12v-78.562c-0.046875-4.5 1.7344-8.8125 4.9219-12s7.5-4.9688 11.953-4.9688h78.656c4.5 0 8.8125 1.7812 11.953 4.9688 3.1875 3.1875 4.9688 7.5 4.9688 12zm561.47-232.78 0.046875-0.046874c0-4.5-1.7812-8.8125-4.9688-12-3.1875-3.1406-7.5-4.9219-11.953-4.9219h-78.656c-9.3281 0-16.922 7.5469-16.922 16.922v78.656-0.046876c0 9.375 7.5938 16.922 16.922 16.922h78.656c4.4531 0 8.7656-1.7812 11.953-4.9219 3.1875-3.1875 4.9688-7.5 4.9688-12v-78.562zm-281.53 0v78.656l0.046875-0.09375c0 4.5-1.7812 8.8125-4.9688 12-3.1406 3.1406-7.4531 4.9219-11.953 4.9219h-77.062c-9.3281 0-16.922-7.5469-16.922-16.922v-78.562c0-9.3281 7.5938-16.922 16.922-16.922h77.062c4.5 0 8.8125 1.7812 11.953 4.9688 3.1875 3.1406 4.9688 7.4531 4.9688 11.953zm-279.94 0v78.656l0.046875-0.09375c0 9.375-7.5938 16.922-16.922 16.922h-78.656c-9.3281 0-16.875-7.5469-16.875-16.922v-78.562c0-9.3281 7.5469-16.922 16.875-16.922h78.656c9.3281 0 16.922 7.5938 16.922 16.922zm561.47-232.78 0.046875-0.09375c0-9.3281-7.5938-16.922-16.922-16.922h-78.656c-9.3281 0-16.922 7.5938-16.922 16.922v77.062c0 9.3281 7.5938 16.922 16.922 16.922h78.656c9.3281 0 16.922-7.5469 16.922-16.922z" fill-rule="evenodd"/>
        </svg>
      </div>
      <div class="brandText">
        <div class="brandName">Liberal Markets</div>
        <div class="brandTag">minimal finance notes</div>
      </div>
    </div>

    <nav class="nav">
      <button class="chip" data-nav="all" type="button" aria-pressed="true">
        <span class="chipDot" aria-hidden="true"></span> Home
      </button>
      <button class="chip" data-nav="trumptracker" type="button" aria-pressed="false">
        <span class="chipDot" aria-hidden="true"></span> Trump Tracker
      </button>
      <button class="chip is-active" data-nav="markets" type="button" aria-pressed="false">
        <span class="chipDot" aria-hidden="true"></span> Markets
      </button>
    </nav>

    <div class="actions">
      <label class="search" aria-label="Search posts">
        <span class="searchIcon" aria-hidden="true">
          <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M20 20l-3.2-3.2"></path>
          </svg>
        </span>
        <input id="q" type="search" placeholder="Search… (e.g., “yield”, “CPI”, “DCF”)" autocomplete="off" />
        <span class="kbd" aria-hidden="true">⌘K</span>
      </label>

    </div>
  </header>

  <main id="main" class="wrap">
    <section class="hero">
      <div class="heroLeft">
        <div class="heroKicker">
          <span class="pulse" aria-hidden="true"></span>
          <span id="lastSync">Sync: —</span>
        </div>

        <h1 class="heroTitle">
          The right place to think about economics
          <span class="ghost">without the spin.</span>
        </h1>

        <p class="heroBody">
          Short memos, charts, and sanity checks. Built like a blueprint:
          light ink, clean grid, wireframe iconography.
        </p>

        <div class="heroMeta">
          <div class="stat">
            <div class="statIcon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M192 160L192 144C192 99.8 278 64 384 64C490 64 576 99.8 576 144L576 160C576 190.6 534.7 217.2 474 230.7C471.6 227.9 469.1 225.2 466.6 222.7C451.1 207.4 431.1 195.8 410.2 187.2C368.3 169.7 313.7 160.1 256 160.1C234.1 160.1 212.7 161.5 192.2 164.2C192 162.9 192 161.5 192 160.1zM496 417L496 370.8C511.1 366.9 525.3 362.3 538.2 356.9C551.4 351.4 564.3 344.7 576 336.6L576 352C576 378.8 544.5 402.5 496 417zM496 321L496 288C496 283.5 495.6 279.2 495 275C510.5 271.1 525 266.4 538.2 260.8C551.4 255.2 564.3 248.6 576 240.5L576 255.9C576 282.7 544.5 306.4 496 320.9zM64 304L64 288C64 243.8 150 208 256 208C362 208 448 243.8 448 288L448 304C448 348.2 362 384 256 384C150 384 64 348.2 64 304zM448 400C448 444.2 362 480 256 480C150 480 64 444.2 64 400L64 384.6C75.6 392.7 88.5 399.3 101.8 404.9C143.7 422.4 198.3 432 256 432C313.7 432 368.3 422.3 410.2 404.9C423.4 399.4 436.3 392.7 448 384.6L448 400zM448 480.6L448 496C448 540.2 362 576 256 576C150 576 64 540.2 64 496L64 480.6C75.6 488.7 88.5 495.3 101.8 500.9C143.7 518.4 198.3 528 256 528C313.7 528 368.3 518.3 410.2 500.9C423.4 495.4 436.3 488.7 448 480.6z"/></svg>
            </div>
            <div class="statText">
              <div class="statLabel" id="cpiLabel">CPI (Index)</div>
              <div class="statValue" id="cpiVal">—</div>
            </div>
          </div>

          <div class="stat">
            <div class="statIcon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M128 496L128 320C92.7 320 64 291.3 64 256C64 39.5 576 39.5 576 256C576 291.3 547.3 320 512 320L512 496C512 522.5 490.5 544 464 544L176 544C149.5 544 128 522.5 128 496z"/></svg>
            </div>
            <div class="statText">
              <div class="statLabel" id="unrateLabel">U-Rate</div>
              <div class="statValue" id="unrateVal">—</div>
            </div>
          </div>

          <div class="stat">
            <div class="statIcon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M415.9 344L225 344C227.9 408.5 242.2 467.9 262.5 511.4C273.9 535.9 286.2 553.2 297.6 563.8C308.8 574.3 316.5 576 320.5 576C324.5 576 332.2 574.3 343.4 563.8C354.8 553.2 367.1 535.8 378.5 511.4C398.8 467.9 413.1 408.5 416 344zM224.9 296L415.8 296C413 231.5 398.7 172.1 378.4 128.6C367 104.2 354.7 86.8 343.3 76.2C332.1 65.7 324.4 64 320.4 64C316.4 64 308.7 65.7 297.5 76.2C286.1 86.8 273.8 104.2 262.4 128.6C242.1 172.1 227.8 231.5 224.9 296zM176.9 296C180.4 210.4 202.5 130.9 234.8 78.7C142.7 111.3 74.9 195.2 65.5 296L176.9 296zM65.5 344C74.9 444.8 142.7 528.7 234.8 561.3C202.5 509.1 180.4 429.6 176.9 344L65.5 344zM463.9 344C460.4 429.6 438.3 509.1 406 561.3C498.1 528.6 565.9 444.8 575.3 344L463.9 344zM575.3 296C565.9 195.2 498.1 111.3 406 78.7C438.3 130.9 460.4 210.4 463.9 296L575.3 296z"/></svg>
            </div>
            <div class="statText">
              <div class="statLabel" id="gdpLabel">GDP</div>
              <div class="statValue" id="gdpVal">—</div>
            </div>
          </div>

          <div class="stat">
            <div class="statIcon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M128 96C92.7 96 64 124.7 64 160L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 256C576 220.7 547.3 192 512 192L136 192C122.7 192 112 181.3 112 168C112 154.7 122.7 144 136 144L520 144C533.3 144 544 133.3 544 120C544 106.7 533.3 96 520 96L128 96zM480 320C497.7 320 512 334.3 512 352C512 369.7 497.7 384 480 384C462.3 384 448 369.7 448 352C448 334.3 462.3 320 480 320z"/></svg>
            </div>
            <div class="statText">
              <div class="statLabel" id="mincLabel">Median Income</div>
              <div class="statValue" id="mincVal">—</div>
            </div>
          </div>

          <div class="stat">
            <div class="statIcon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M341.8 72.6C329.5 61.2 310.5 61.2 298.3 72.6L74.3 280.6C64.7 289.6 61.5 303.5 66.3 315.7C71.1 327.9 82.8 336 96 336L112 336L112 512C112 547.3 140.7 576 176 576L464 576C499.3 576 528 547.3 528 512L528 336L544 336C557.2 336 569 327.9 573.8 315.7C578.6 303.5 575.4 289.5 565.8 280.6L341.8 72.6zM304 384L336 384C362.5 384 384 405.5 384 432L384 528L256 528L256 432C256 405.5 277.5 384 304 384z"/></svg>
            </div>
            <div class="statText">
              <div class="statLabel" id="mhouLabel">Median Home Cost</div>
              <div class="statValue" id="mhouVal">—</div>
            </div>
          </div>

          <div class="stat">
            <div class="statIcon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2026 Fonticons, Inc.--><path d="M528 320C528 205.1 434.9 112 320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM398.7 448.6C383.7 433 357.6 416 320 416C282.4 416 256.3 433 241.3 448.6C232.1 458.2 216.9 458.5 207.4 449.3C197.9 440.1 197.5 424.9 206.7 415.4C228.8 392.4 266.7 368 320 368C373.3 368 411.2 392.4 433.3 415.4C442.5 425 442.2 440.2 432.6 449.3C423 458.4 407.8 458.2 398.7 448.6zM208 272C208 254.3 222.3 240 240 240C257.7 240 272 254.3 272 272C272 289.7 257.7 304 240 304C222.3 304 208 289.7 208 272zM400 240C417.7 240 432 254.3 432 272C432 289.7 417.7 304 400 304C382.3 304 368 289.7 368 272C368 254.3 382.3 240 400 240z"/></svg>
            </div>
            <div class="statText">
              <div class="statLabel" id="ratioLabel">Housing/Income Ratio</div>
              <div class="statValue" id="ratioVal">—</div>
            </div>
          </div>


        </div>
      </div>

      <aside class="heroRight" aria-label="Mini market panel">
        <div class="panelHead">
          <div class="panelTitle">Tape</div>
          <div class="panelHint">Open/Close Return</div>
        </div>

        <ul class="tape" id="tape" role="list"></ul>

        <div class="panelFoot">
          <div class="note">
            <span class="noteIcon" aria-hidden="true">
              <!-- wireframe info -->
              <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="9"></circle>
                <path d="M12 11v5"></path>
                <path d="M12 8h.01"></path>
              </svg>
            </span>
            <span>Press <span class="kbdInline">⌘ + K</span> to focus search.</span>
          </div>
        </div>
      </aside>

    </section>

    <section class="hmSection" aria-label="Stock heatmap">
      <div class="hmHead">
        <div>
          <div class="hmKicker">MARKETS</div>
          <h2 class="hmTitle">Stock heatmap</h2>
          <p class="hmSub">Daily close-to-close moves, sourced from Stooq. Equal-size tiles because market-cap math on the client is how you get bugs and ulcers.</p>
        </div>

        <div class="hmActions">
          <button class="btn" id="hmRefresh" type="button" title="Refresh heatmap">Refresh</button>
          <span class="hmStamp muted" id="hmStamp">Updated: —</span>
        </div>
      </div>

      <div class="hmGrid" id="hmGrid" role="list" aria-label="Heatmap tiles"></div>

      <div class="hmLegend" aria-label="Legend">
        <span class="muted">Legend:</span>
        <span><span class="hmSwatch hmDn3"></span> down big</span>
        <span><span class="hmSwatch hmDn2"></span> down</span>
        <span><span class="hmSwatch hmDn1"></span> slightly down</span>
        <span><span class="hmSwatch hmFlat"></span> flat</span>
        <span><span class="hmSwatch hmUp1"></span> slightly up</span>
        <span><span class="hmSwatch hmUp2"></span> up</span>
        <span><span class="hmSwatch hmUp3"></span> up big</span>
      </div>
    </section>


    <footer class="footer">
      <div class="footerLeft">
        <span class="footMark" aria-hidden="true"></span>
        <span>Liberal Markets</span>
        <span class="muted">© <span id="year"></span></span>
      </div>
      <div class="footerRight">
        <a class="footLink" href="#" id="exportBtn">Export pins</a>
        <span class="muted">No trackers. No noise.</span>
      </div>
    </footer>
  </main>

  <dialog class="modal" id="modal">
    <form method="dialog" class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">Quick Search</div>
        <button class="x" value="cancel" aria-label="Close">
          <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M6 6l12 12"></path>
            <path d="M18 6l-12 12"></path>
          </svg>
        </button>
      </div>

      <label class="modalSearch">
        <input id="modalQ" type="search" placeholder="Type to filter posts…" autocomplete="off" />
      </label>

      <div class="modalList" id="modalList"></div>

      <div class="modalFoot">
        <span class="muted">Enter opens. Esc closes. Humans remain complicated.</span>
      </div>
    </form>
  </dialog>

  <script src="app.js?v=3"></script>
  <script src="scripts/chart.js?v=1"></script>
  <script>
    /**
     * Heatmap renderer (reads /heatmap.json generated by scripts/fetch-tape.mjs).
     * No direct Stooq client fetch because CORS is a thing that exists to ruin your day.
     */
    (function () {


    /**
     * Decide how to decorate the numeric value based on Stooq symbol suffix.
     * - *.us -> USD ($)
     * - *.b  -> percent (%)
     * - otherwise -> plain number (no symbol)
     *
     * @param {string} sym
     * @param {number} value
     * @returns {string}
     */
    function formatValueBySym(sym, value) {
    if (!Number.isFinite(value)) return "—";

    const s = String(sym ?? "").trim().toLowerCase();

    if (s.endsWith(".us")) {
        return `$${fmtPx(value)}`;
    }

    if (s.includes("hsi")) {
        return `HK$${fmtPx(value)}`;
    }

    if (s.includes("nkx")) {
        return `¥${fmtPx(value)}`;
    }

    if (s.includes("snx")) {
        return `₹${fmtPx(value)}`;
    }

    if (s.includes("dax")) {
        return `€${fmtPx(value)}`;
    }

    if (s.includes("ukx")) {
        return `£${fmtPx(value)}`;
    }
    
    if (s.endsWith(".b")) {
        // yields/rates typically come as already “4.17” meaning 4.17%
        return `${fmtPx(value)}%`;
    }

    // everything else: no symbol
    return fmtPx(value);
    }


      const grid = document.getElementById("hmGrid");
      const stamp = document.getElementById("hmStamp");
      const btn = document.getElementById("hmRefresh");

      if (!grid || !stamp || !btn) return;

      /**
       * Map percent change into a subtle color band.
       * @param {number} pct
       * @returns {string}
       */
      function bandClass(pct) {
        if (!Number.isFinite(pct)) return "hmFlat";
        if (pct <= -2.0) return "hmDn3";
        if (pct <= -1.0) return "hmDn2";
        if (pct <= -0.25) return "hmDn1";
        if (pct < 0.25) return "hmFlat";
        if (pct < 1.0) return "hmUp1";
        if (pct < 2.0) return "hmUp2";
        return "hmUp3";
      }

      /**
       * Format a percent change.
       * @param {number} pct
       * @returns {string}
       */
      function fmtPct(pct) {
        if (!Number.isFinite(pct)) return "—";
        const sign = pct > 0 ? "+" : "";
        return `${sign}${pct.toFixed(2)}%`;
      }

      /**
       * Format price (keep it simple and readable).
       * @param {number} px
       * @returns {string}
       */
      function fmtPx(px) {
        if (!Number.isFinite(px)) return "—";
        if (Math.abs(px) >= 1000) return px.toFixed(0);
        if (Math.abs(px) >= 100) return px.toFixed(1);
        return px.toFixed(2);
      }

      /**
       * Render heatmap tiles.
       * @param {{generatedAt:string, items:Array<any>}} payload
       */
      function render(payload) {
        const items = Array.isArray(payload?.items) ? payload.items : [];
        grid.innerHTML = "";

        for (const it of items) {
          const pct = Number(it.deltaPct);
          const close = Number(it.close);

          const tile = document.createElement("button");
          tile.type = "button";
          tile.className = `hmTile ${bandClass(pct)}`;
          tile.setAttribute("role", "listitem");
          tile.title = it.ok === false ? `Failed: ${it.error ?? "unknown"}` : "Open on Stooq";

          const symLabel = String(it.sym ?? "").toUpperCase();
          const group = it.group ? String(it.group) : "";

          tile.innerHTML = `
            <div class="hmSym">${symLabel}</div>
            <div class="hmName">${it.name ?? symLabel}</div>
            ${group ? `<div class="hmTag">${group}</div>` : ""}
            <div class="hmNums">
              <div class="hmPct">${it.ok === false ? "—" : fmtPct(pct)}</div>
              <div class="hmPx">${it.ok === false ? "" : formatValueBySym(it.sym, close)}</div>
            </div>
          `;

          tile.addEventListener("click", () => {
            const sym = encodeURIComponent(it.sym ?? "");
            if (!sym) return;
            window.open(`https://stooq.com/q/?s=${sym}`, "_blank", "noopener,noreferrer");
          });

          grid.appendChild(tile);
        }

        const ts = payload?.generatedAt ? new Date(payload.generatedAt) : null;
        stamp.textContent = ts && !Number.isNaN(ts.getTime())
          ? `Updated: ${ts.toLocaleString()}`
          : "Updated: —";
      }

      /**
       * Fetch heatmap.json from the same origin.
       */
      async function load() {
        grid.innerHTML = "";
        const skeleton = document.createElement("div");
        skeleton.className = "muted";
        skeleton.textContent = "Loading heatmap…";
        grid.appendChild(skeleton);

        try {
          const res = await fetch(`heatmap.json?v=${Date.now()}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          render(payload);
        } catch (e) {
          grid.innerHTML = "";
          const err = document.createElement("div");
          err.className = "muted";
          err.textContent = `Heatmap failed to load (${e instanceof Error ? e.message : String(e)}).`;
          grid.appendChild(err);
        }
      }

      btn.addEventListener("click", load);
      load();
    })();
  </script>
</body>
</html>