<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Liberal Markets — Minimal Finance Notes</title>
  <link rel="icon" type="image/svg+xml" href="assets/liberalmarketslogo.svg">
  <meta name="description" content="Minimalist finance blog with wireframe iconography and calm, earthy palette." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="styles.css?v=5" />
  <style>
    /* Heatmap: same “wireframe card” vibe, just… colored by reality */
    .hmSection {
      margin-top: 18px;
      padding: 18px;
      border-radius: 12px;
      border: 1px solid rgba(86, 255, 168, .24);
      background:
        linear-gradient(180deg, rgba(10, 10, 10, .92), rgba(5, 5, 5, .94)),
        radial-gradient(circle at 15% 10%, rgba(86, 255, 168, .08), transparent 45%);
      box-shadow: 0 14px 36px rgba(0, 0, 0, .45);
      position: relative;
      overflow: hidden;
    }
    .hmSection::before{
      content:"";
      position:absolute;
      inset: -40% -10%;
      background:
        repeating-linear-gradient(0deg, rgba(86, 255, 168, .06) 0 1px, transparent 1px 18px),
        repeating-linear-gradient(90deg, rgba(86, 255, 168, .05) 0 1px, transparent 1px 22px);
      opacity: .35;
      pointer-events: none;
    }
    .hmHead {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }
    .hmKicker {
      font-size: 11px;
      letter-spacing: .24em;
      text-transform: uppercase;
      opacity: .75;
    }
    .hmTitle {
      margin: 6px 0 6px;
      font-size: 22px;
      line-height: 1.15;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
    .hmSub {
      margin: 0;
      max-width: 70ch;
      opacity: .8;
    }
    .hmActions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .hmControlRow {
      margin-top: 10px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .hmFilters {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .hmChip {
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(7, 7, 7, .9);
      color: inherit;
      cursor: pointer;
    }
    .hmChip.is-active {
      border-color: rgba(86, 255, 168, .7);
      box-shadow: inset 0 0 12px rgba(86, 255, 168, .14);
    }
    .hmToggle {
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .32);
      background: rgba(6, 6, 6, .9);
      color: inherit;
      cursor: pointer;
    }
    .hmToggle.is-active {
      border-color: rgba(86, 255, 168, .7);
      box-shadow: inset 0 0 16px rgba(86, 255, 168, .16);
    }
    .hmActionBtn {
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .32);
      background: rgba(6, 6, 6, .9);
      color: inherit;
      cursor: pointer;
    }
    .hmActionBtn:hover {
      border-color: rgba(86, 255, 168, .55);
      box-shadow: inset 0 0 14px rgba(86, 255, 168, .12);
    }
    .hmStamp {
      font-size: 12px;
    }
    .hmGrid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 10px;
    }
    .hmGrid.is-focus {
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px;
    }
    .hmGrid.is-focus .hmTile {
      min-height: 110px;
      font-size: 1.05em;
    }
    .hmGrid.is-focus .hmName {
      font-size: 16px;
    }
    .hmGrid.is-focus .hmPct {
      font-size: 16px;
    }
    .hmGrid.is-focus .hmPx {
      font-size: 12px;
    }
    @media (max-width: 1100px) {
      .hmGrid.is-focus { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 720px) {
      .hmGrid.is-focus { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .hmGrid.is-sized {
      grid-auto-rows: 58px;
      grid-auto-flow: dense;
    }
    .hmGrid.is-sized .hmTile {
      min-height: 58px;
    }
    @media (max-width: 1100px) {
      .hmGrid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (max-width: 720px) {
      .hmGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .hmHead { flex-direction: column; }
      .hmActions { justify-content: flex-start; }
    }
    @media (min-width: 1400px) {
      .hmGrid { grid-template-columns: repeat(8, minmax(0, 1fr)); }
    }
    .hmGrid.is-grouped {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 980px) {
      .hmGrid.is-grouped { grid-template-columns: 1fr; }
    }
    .hmGroup {
      border-radius: 12px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(7, 7, 7, .9);
      padding: 10px 12px 12px;
      position: relative;
      overflow: hidden;
    }
    .hmGroup::before {
      content: "";
      position: absolute;
      inset: -40% -10%;
      background:
        repeating-linear-gradient(0deg, rgba(86, 255, 168, .04) 0 1px, transparent 1px 20px),
        repeating-linear-gradient(90deg, rgba(86, 255, 168, .03) 0 1px, transparent 1px 24px);
      opacity: .25;
      pointer-events: none;
    }
    .hmGroupHead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }
    .hmGroupTitle {
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
    }
    .hmGroupCount {
      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity: .6;
    }
    .hmGroupGrid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      position: relative;
      z-index: 1;
    }
    .hmGroupGrid.is-sized {
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-auto-rows: 56px;
      grid-auto-flow: dense;
    }
    .hmGroupGrid.is-sized .hmTile {
      min-height: 56px;
    }
    @media (max-width: 1100px) {
      .hmGroupGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .hmGroupGrid.is-sized { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 720px) {
      .hmGroupGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .hmTile {
      position: relative;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .18);
      background: rgba(8, 8, 8, .88);
      box-shadow:
        inset 0 0 0 1px rgba(86, 255, 168, .08),
        inset 0 12px 18px rgba(0, 0, 0, .28);
      cursor: pointer;
      text-align: left;
      min-height: 78px;
      display: grid;
      gap: 4px;
      align-content: start;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .hmGrid.is-sized .hmTile,
    .hmGroupGrid.is-sized .hmTile {
      padding: 6px 8px;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 4px;
    }
    .hmGrid.is-sized .hmTile .hmName,
    .hmGroupGrid.is-sized .hmTile .hmName,
    .hmGrid.is-sized .hmTile .hmPx,
    .hmGroupGrid.is-sized .hmTile .hmPx,
    .hmGrid.is-sized .hmTile .hmTip,
    .hmGroupGrid.is-sized .hmTile .hmTip,
    .hmGrid.is-sized .hmTile .hmTag,
    .hmGroupGrid.is-sized .hmTile .hmTag {
      display: none;
    }
    .hmGrid.is-sized .hmTile .hmSym,
    .hmGroupGrid.is-sized .hmTile .hmSym {
      font-size: 11px;
      letter-spacing: .16em;
      opacity: .9;
    }
    .hmGrid.is-sized .hmTile .hmNums,
    .hmGroupGrid.is-sized .hmTile .hmNums {
      margin-top: 0;
    }
    .hmGrid.is-sized .hmTile .hmPct,
    .hmGroupGrid.is-sized .hmTile .hmPct {
      font-size: 14px;
    }

    /* Group accent bar (set via data-group in JS) */
    .hmTile::before {
      display: none;
    }

    .hmTile:hover {
      transform: translateY(-2px);
      filter: contrast(1.08) saturate(1.1);
      border-color: rgba(86, 255, 168, .35);
      box-shadow:
        inset 0 0 0 1px rgba(86, 255, 168, .12),
        0 14px 28px rgba(0,0,0,.45);
    }

    .hmTile:active { transform: translateY(-1px) scale(1.005); }

    .hmTile:focus-visible {
      outline: 2px solid rgba(86, 255, 168, .55);
      outline-offset: 2px;
    }
    .hmTip {
      position: absolute;
      left: 10px;
      bottom: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(86, 255, 168, .25);
      background: rgba(6, 6, 6, .85);
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events: none;
      max-width: calc(100% - 20px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .hmTile:hover .hmTip,
    .hmTile:focus-visible .hmTip {
      opacity: .92;
      transform: translateY(0);
    }

    /* Group accent colors */
    .hmTile[data-group="index"]  { --hmGroupBar: rgba(86, 255, 168, .55); }
    .hmTile[data-group="mega"]   { --hmGroupBar: rgba(86, 255, 168, .38); }
    .hmTile[data-group="large"]  { --hmGroupBar: rgba(86, 255, 168, .30); }
    .hmTile[data-group="sector"] { --hmGroupBar: rgba(86, 255, 168, .46); }
    .hmTile[data-group="macro"]  { --hmGroupBar: rgba(86, 255, 168, .26); }
    .hmTile[data-group="crypto"] { --hmGroupBar: rgba(110, 195, 255, .55); }

    .hmSym {
      font-size: 10.5px;
      letter-spacing: .18em;
      text-transform: uppercase;
      opacity: .7;
    }
    .hmName {
      font-size: 14px;
      line-height: 1.2;
      font-weight: 600;
      opacity: .98;
    }
    .hmNums {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-top: 2px;
    }
    .hmPct {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: .02em;
    }
    .hmPct.is-up { color: rgba(86, 255, 168, .98); }
    .hmPct.is-dn { color: rgba(255, 98, 122, .95); }
    .hmPct.is-flat { color: rgba(230, 246, 239, .70); }
    .hmPx {
      font-variant-numeric: tabular-nums;
      opacity: .78;
      font-size: 11.5px;
      letter-spacing: .01em;
      padding-left: 10px;
      position: relative;
    }
    .hmPx::before {
    content: "·";
    position: absolute;
    left: 2px;
    top: 0;
    opacity: .55;
    }
    .hmTag {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      opacity: .75;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(86, 255, 168, .24);
      background: rgba(6, 6, 6, .7);
    }

    /* Color bands (subtle, not Vegas). */
    .hmDn3 { background: rgba(255, 98, 122, .26); }
    .hmDn2 { background: rgba(255, 98, 122, .18); }
    .hmDn1 { background: rgba(255, 98, 122, .12); }
    .hmFlat { background: rgba(10, 10, 10, .45); }
    .hmUp1 { background: rgba(86, 255, 168, .12); }
    .hmUp2 { background: rgba(86, 255, 168, .18); }
    .hmUp3 { background: rgba(86, 255, 168, .26); }

    .hmLegend {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      opacity: .85;
    }
    .hmSwatch {
      width: 14px;
      height: 10px;
      border-radius: 3px;
      border: 1px solid rgba(86, 255, 168, .18);
      display: inline-block;
      vertical-align: middle;
    }

    .terminalHead {
      margin-top: 10px;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid rgba(86, 255, 168, .28);
      background: rgba(8, 8, 8, .92);
      box-shadow: 0 16px 36px rgba(0, 0, 0, .5);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      position: relative;
      overflow: hidden;
    }
    .terminalHead::before {
      content: "";
      position: absolute;
      inset: -40% -10%;
      background:
        repeating-linear-gradient(0deg, rgba(86, 255, 168, .05) 0 1px, transparent 1px 18px),
        repeating-linear-gradient(90deg, rgba(86, 255, 168, .04) 0 1px, transparent 1px 22px);
      opacity: .35;
      pointer-events: none;
    }
    .terminalTitle {
      font-size: 20px;
      text-transform: uppercase;
      letter-spacing: .22em;
    }
    .terminalMeta {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 10.5px;
      letter-spacing: .16em;
      text-transform: uppercase;
      opacity: .78;
    }
    .statusDot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      border: 1px solid rgba(86, 255, 168, .6);
      background: rgba(86, 255, 168, .4);
      box-shadow: 0 0 12px rgba(86, 255, 168, .55);
      display: inline-block;
    }
    .terminalRight {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      position: relative;
      z-index: 1;
    }
    .kbdRow {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }
    .kbdKey {
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      padding: 5px 7px;
      border-radius: 6px;
      border: 1px solid rgba(86, 255, 168, .28);
      background: rgba(7, 7, 7, .9);
      color: inherit;
      font: inherit;
      cursor: pointer;
      appearance: none;
      position: relative;
      overflow: hidden;
      isolation: isolate;
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease, background .18s ease;
    }
    .kbdKey.is-active {
      border-color: rgba(86, 255, 168, .75);
      box-shadow: 0 0 0 1px rgba(86, 255, 168, .2), inset 0 0 18px rgba(86, 255, 168, .08);
      background: rgba(10, 12, 10, .95);
    }
    .kbdKey.is-active::before {
      content: "";
      position: absolute;
      inset: -30% -10%;
      background: radial-gradient(circle at 30% 30%, rgba(86, 255, 168, .25), transparent 55%);
      opacity: .6;
      z-index: 0;
      pointer-events: none;
    }
    .kbdKey.is-pulse::after {
      content: "";
      position: absolute;
      left: -10%;
      right: -10%;
      height: 2px;
      top: 50%;
      background: linear-gradient(90deg, transparent, rgba(86, 255, 168, .9), transparent);
      opacity: 0;
      animation: scanline 0.9s ease;
      z-index: 0;
      pointer-events: none;
    }
    .kbdKey:focus-visible {
      outline: 2px solid rgba(86, 255, 168, .6);
      outline-offset: 2px;
    }
    @keyframes scanline {
      0% { transform: translateY(-14px); opacity: 0; }
      35% { opacity: .85; }
      100% { transform: translateY(14px); opacity: 0; }
    }
    .view-overview,
    .view-tables,
    .view-heatmap {
      display: block;
    }
    body[data-view="overview"] .view-tables,
    body[data-view="overview"] .view-heatmap {
      display: none;
    }
    body[data-view="tables"] .view-overview,
    body[data-view="tables"] .view-heatmap {
      display: none;
    }
    body[data-view="heatmap"] .view-overview,
    body[data-view="heatmap"] .view-tables {
      display: none;
    }
    body.markets[data-view="overview"] {
      background:
        radial-gradient(circle at 20% 12%, rgba(86,255,168,.10), transparent 42%),
        radial-gradient(circle at 85% 20%, rgba(17,207,162,.12), transparent 45%),
        linear-gradient(180deg, #050505, #020202);
    }
    body.markets[data-view="tables"] {
      background:
        radial-gradient(circle at 18% 18%, rgba(86,255,168,.08), transparent 40%),
        radial-gradient(circle at 80% 10%, rgba(86,255,168,.06), transparent 45%),
        linear-gradient(180deg, #060607, #020203);
    }
    body.markets[data-view="heatmap"] {
      background:
        radial-gradient(circle at 30% 14%, rgba(86,255,168,.14), transparent 45%),
        radial-gradient(circle at 78% 35%, rgba(255,98,122,.10), transparent 50%),
        linear-gradient(180deg, #050506, #010101);
    }
    .terminalHint {
      font-size: 10px;
      letter-spacing: .2em;
      text-transform: uppercase;
      opacity: .6;
    }
    .sessionStrip {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .sessionTitle {
      font-size: 9.5px;
      letter-spacing: .24em;
      text-transform: uppercase;
      opacity: .7;
    }
    .sessionPill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(8, 8, 8, .9);
      font-size: 9.5px;
      letter-spacing: .18em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .sessionDot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(230, 246, 239, .4);
      box-shadow: 0 0 8px rgba(86, 255, 168, .2);
    }
    .sessionName {
      opacity: .9;
    }
    .sessionTime {
      opacity: .7;
    }
    .sessionState {
      opacity: .8;
    }
    .sessionPill[data-state="open"] {
      border-color: rgba(86, 255, 168, .55);
      background: rgba(10, 12, 10, .95);
    }
    .sessionPill[data-state="open"] .sessionDot {
      background: rgba(86, 255, 168, .95);
      box-shadow: 0 0 10px rgba(86, 255, 168, .45);
    }
    .sessionPill[data-state="pre"] {
      border-color: rgba(255, 198, 86, .55);
    }
    .sessionPill[data-state="pre"] .sessionDot {
      background: rgba(255, 198, 86, .9);
      box-shadow: 0 0 10px rgba(255, 198, 86, .35);
    }
    .sessionPill[data-state="after"] {
      border-color: rgba(255, 98, 122, .45);
    }
    .sessionPill[data-state="after"] .sessionDot {
      background: rgba(255, 98, 122, .85);
      box-shadow: 0 0 10px rgba(255, 98, 122, .35);
    }
    .sessionPill[data-state="lunch"] {
      border-color: rgba(255, 198, 86, .55);
    }
    .sessionPill[data-state="lunch"] .sessionDot {
      background: rgba(255, 198, 86, .9);
      box-shadow: 0 0 10px rgba(255, 198, 86, .35);
    }
    .sessionPill[data-state="closed"] .sessionDot {
      background: rgba(230, 246, 239, .35);
      box-shadow: none;
    }
    .marketClock {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .clockRing {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: conic-gradient(rgba(86, 255, 168, .9) 0deg, rgba(86, 255, 168, .9) 0deg, rgba(86, 255, 168, .12) 0deg 360deg);
      position: relative;
      box-shadow: inset 0 0 0 1px rgba(86, 255, 168, .2);
    }
    .clockRing::after {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      background: rgba(7, 7, 7, .92);
      box-shadow: inset 0 0 0 1px rgba(86, 255, 168, .18);
    }
    .clockLabel {
      font-size: 10px;
      letter-spacing: .2em;
      text-transform: uppercase;
      opacity: .7;
    }
    .panelTabs {
      display: inline-flex;
      gap: 6px;
    }
    .panelTab {
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid rgba(86, 255, 168, .24);
      background: rgba(7, 7, 7, .9);
      color: inherit;
      cursor: pointer;
    }
    .panelTab.is-active {
      border-color: rgba(86, 255, 168, .6);
      box-shadow: inset 0 0 12px rgba(86, 255, 168, .12);
    }
    .boardRows.is-hidden {
      display: none;
    }

    .tickerStrip {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .24);
      background: rgba(7, 7, 7, .9);
      display: flex;
      align-items: center;
      gap: 12px;
      overflow: hidden;
    }
    .tickerLabel {
      font-size: 10px;
      letter-spacing: .28em;
      text-transform: uppercase;
      color: rgba(86, 255, 168, .9);
    }
    .tickerMarquee {
      display: flex;
      gap: 12px;
      overflow: hidden;
      flex: 1;
      padding-bottom: 2px;
    }
    .tickerTrack {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-shrink: 0;
      width: max-content;
      animation: ticker-scroll 42s linear infinite;
      padding-right: 12px;
    }
    .tickerStrip:hover .tickerTrack{
      animation-play-state: paused;
    }
    .tickerItem {
      display: flex;
      align-items: baseline;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(86, 255, 168, .2);
      background: rgba(8, 8, 8, .85);
      white-space: nowrap;
    }
    .tickerSym {
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      opacity: .75;
    }
    .tickerPx {
      font-variant-numeric: tabular-nums;
      font-size: 12px;
    }
    .tickerChg {
      font-variant-numeric: tabular-nums;
      font-size: 11px;
    }
    .tickerChg.is-up { color: rgba(86, 255, 168, .98); }
    .tickerChg.is-dn { color: rgba(255, 98, 122, .95); }
    .tickerChg.is-flat { color: rgba(230, 246, 239, .7); }

    .newsTicker {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .24);
      background: rgba(7, 7, 7, .92);
      display: flex;
      align-items: center;
      gap: 12px;
      overflow: hidden;
    }
    .newsLabel {
      font-size: 10px;
      letter-spacing: .28em;
      text-transform: uppercase;
      color: rgba(86, 255, 168, .9);
    }
    .newsMarquee {
      display: flex;
      gap: 16px;
      overflow: hidden;
      flex: 1;
    }
    .newsTrack {
      display: flex;
      gap: 18px;
      flex-shrink: 0;
      width: max-content;
      animation: news-scroll 400s linear infinite;
      padding-right: 18px;
    }
    .newsTicker:hover .newsTrack{
      animation-play-state: paused;
    }
    .newsItem {
      font-size: 10px;
      letter-spacing: .1em;
      text-transform: uppercase;
      opacity: .78;
      white-space: nowrap;
      color: inherit;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 8px;
      padding: 2px 0;
    }
    .newsItem:hover{
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .newsText {
      opacity: .8;
    }
    .newsTags {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }
    .newsTag {
      font-size: 9px;
      letter-spacing: .12em;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(86, 255, 168, .28);
      background: rgba(8, 8, 8, .9);
      color: rgba(86, 255, 168, .9);
    }
    .newsTag.is-hot {
      border-color: rgba(255, 198, 86, .6);
      color: rgba(255, 198, 86, .92);
    }

    .overviewTop {
      margin-top: 10px;
      display: grid;
      grid-template-columns: clamp(360px, 31vw, 540px) minmax(0, 1fr);
      gap: 12px;
      align-items: start;
    }
    .alertConsole {
      margin-top: 0;
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .26);
      background:
        linear-gradient(180deg, rgba(8, 10, 9, .95), rgba(6, 6, 6, .95)),
        repeating-linear-gradient(90deg, rgba(86, 255, 168, .04) 0 1px, transparent 1px 20px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .34);
      padding: 8px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 7px;
    }
    .alertSummary {
      border-radius: 8px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(7, 9, 8, .92);
      padding: 6px 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .alertLabel {
      font-size: 9px;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: rgba(86, 255, 168, .88);
    }
    .alertCount {
      font-size: 18px;
      line-height: 1;
      font-weight: 600;
      letter-spacing: .03em;
      font-variant-numeric: tabular-nums;
    }
    .alertState {
      margin-left: auto;
      font-size: 9px;
      letter-spacing: .1em;
      text-transform: uppercase;
      opacity: .72;
      text-align: right;
    }
    .alertRows {
      display: grid;
      gap: 6px;
      grid-template-columns: 1fr;
    }
    .alertRow {
      --alertTone: rgba(86, 255, 168, .7);
      border-radius: 8px;
      border: 1px solid rgba(86, 255, 168, .22);
      border-left: 3px solid var(--alertTone);
      background: rgba(8, 8, 8, .9);
      padding: 6px 7px;
      display: grid;
      gap: 5px;
    }
    .alertRow.is-live {
      --alertTone: rgba(255, 98, 122, .92);
      box-shadow: inset 0 0 0 1px rgba(255, 98, 122, .18), 0 0 10px rgba(255, 98, 122, .09);
    }
    .alertRow.is-watch {
      --alertTone: rgba(255, 198, 86, .9);
    }
    .alertRow.is-offline {
      --alertTone: rgba(230, 246, 239, .48);
      opacity: .82;
    }
    .alertTop {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 7px;
    }
    .alertRule {
      font-size: 9px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: .9;
    }
    .alertStatus {
      font-size: 8px;
      letter-spacing: .1em;
      text-transform: uppercase;
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid currentColor;
      color: var(--alertTone);
      background: rgba(8, 8, 8, .9);
      white-space: nowrap;
      line-height: 1;
    }
    .alertReadouts {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 9px;
    }
    .alertValue {
      font-variant-numeric: tabular-nums;
      letter-spacing: .06em;
      opacity: .92;
    }
    .alertDelta {
      font-variant-numeric: tabular-nums;
      letter-spacing: .06em;
    }
    .alertDelta.is-up { color: rgba(86, 255, 168, .95); }
    .alertDelta.is-dn { color: rgba(255, 98, 122, .95); }
    .alertDelta.is-flat { color: rgba(230, 246, 239, .74); }
    .alertMeta {
      opacity: .64;
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .alertMeter {
      height: 3px;
      border-radius: 999px;
      border: 1px solid rgba(86, 255, 168, .2);
      background: rgba(4, 4, 4, .9);
      overflow: hidden;
    }
    .alertFill {
      display: block;
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, rgba(17, 207, 162, .9), var(--alertTone));
      transition: width .25s ease;
    }

    .signalGrid {
      margin-top: 0;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .signalCard {
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(8, 8, 8, .9);
      padding: 10px 12px;
      position: relative;
      overflow: hidden;
    }
    .signalCard::after{
      content:"";
      position:absolute;
      left: 10px;
      right: 10px;
      top: 0;
      height: 2px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(86, 255, 168, .85), rgba(17, 207, 162, .6), transparent);
      opacity: .8;
    }
    .signalLabel {
      font-size: 10px;
      letter-spacing: .2em;
      text-transform: uppercase;
      opacity: .7;
    }
    .signalValue {
      margin-top: 8px;
      font-size: 18px;
      letter-spacing: .06em;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    .signalMeta {
      margin-top: 6px;
      font-size: 10px;
      letter-spacing: .18em;
      text-transform: uppercase;
      opacity: .65;
    }
    .signalList {
      margin-top: 8px;
      display: grid;
      gap: 6px;
    }
    .signalRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
    }
    .signalKey {
      letter-spacing: .16em;
      text-transform: uppercase;
      opacity: .6;
    }
    .signalVal {
      font-variant-numeric: tabular-nums;
    }
    .riskRow {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .riskRing {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: conic-gradient(rgba(86, 255, 168, .9) 0deg, rgba(86, 255, 168, .9) 0deg, rgba(86, 255, 168, .14) 0deg 360deg);
      position: relative;
      box-shadow: inset 0 0 0 1px rgba(86, 255, 168, .2);
    }
    .riskRing::after {
      content: "";
      position: absolute;
      inset: 7px;
      border-radius: 50%;
      background: rgba(8, 8, 8, .95);
      box-shadow: inset 0 0 0 1px rgba(86, 255, 168, .16);
    }
    .riskValue {
      font-size: 16px;
      letter-spacing: .08em;
    }
    .riskNote {
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      opacity: .65;
    }

    .corrCard {
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(8, 8, 8, .9);
      padding: 10px 12px;
    }
    .corrWrap {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid rgba(86, 255, 168, .18);
      background: rgba(7, 7, 7, .92);
    }
    .corrTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 10.5px;
      min-width: 460px;
    }
    .corrTable th,
    .corrTable td {
      padding: 6px 8px;
      border-bottom: 1px dashed rgba(86, 255, 168, .16);
      border-right: 1px dashed rgba(86, 255, 168, .14);
      text-align: center;
      font-variant-numeric: tabular-nums;
    }
    .corrTable th:last-child,
    .corrTable td:last-child {
      border-right: 0;
    }
    .corrTable tbody tr:last-child td {
      border-bottom: 0;
    }
    .corrTable th {
      font-size: 10px;
      letter-spacing: .16em;
      text-transform: uppercase;
      opacity: .72;
      background: rgba(6, 6, 6, .94);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .corrRowHead {
      text-align: left;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity: .78;
      background: rgba(6, 6, 6, .92);
      min-width: 80px;
    }
    .corrCell {
      color: rgba(230, 246, 239, .9);
    }
    .corrCell.is-hi {
      background: rgba(86, 255, 168, .2);
      color: rgba(86, 255, 168, .98);
    }
    .corrCell.is-mid {
      background: rgba(86, 255, 168, .12);
      color: rgba(86, 255, 168, .9);
    }
    .corrCell.is-neg {
      background: rgba(255, 98, 122, .14);
      color: rgba(255, 182, 194, .92);
    }
    .corrCell.is-weak {
      color: rgba(230, 246, 239, .68);
    }
    .corrMeta {
      margin-top: 8px;
      font-size: 10px;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity: .66;
    }

    .hotkeysGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }
    .hotkeyRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-radius: 8px;
      border: 1px solid rgba(86, 255, 168, .24);
      background: rgba(7, 7, 7, .9);
      padding: 8px 10px;
    }
    .hotkeyKey {
      font-size: 10px;
      letter-spacing: .2em;
      text-transform: uppercase;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid rgba(86, 255, 168, .28);
      background: rgba(8, 8, 8, .9);
    }
    .hotkeyDesc {
      font-size: 11px;
      opacity: .75;
    }

    .terminalTables {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .terminalLayout {
      margin-top: 14px;
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 16px;
      align-items: start;
    }
    .terminalMain {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .terminalRail {
      position: sticky;
      top: 86px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: fit-content;
    }
    .railBlock {
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(8, 8, 8, .92);
      padding: 10px 12px;
    }
    .railHead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed rgba(86, 255, 168, .28);
      margin-bottom: 8px;
    }
    .railTitleSmall {
      font-size: 11px;
      letter-spacing: .2em;
      text-transform: uppercase;
    }
    .railHint {
      font-size: 10px;
      letter-spacing: .16em;
      text-transform: uppercase;
      opacity: .6;
    }
    .railList {
      display: grid;
      gap: 6px;
    }
    .railRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
    }
    .railSym {
      letter-spacing: .18em;
      text-transform: uppercase;
      opacity: .8;
    }
    .railPx {
      font-variant-numeric: tabular-nums;
    }
    .railChg {
      font-variant-numeric: tabular-nums;
    }
    .railChg.is-up { color: rgba(86, 255, 168, .98); }
    .railChg.is-dn { color: rgba(255, 98, 122, .95); }
    .railChg.is-flat { color: rgba(230, 246, 239, .7); }
    .railEvent {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }
    .railTime {
      letter-spacing: .12em;
      text-transform: uppercase;
      opacity: .7;
    }
    .railEventText {
      opacity: .8;
    }
    .railAlert {
      font-size: 11px;
      opacity: .75;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px dashed rgba(86, 255, 168, .22);
      background: rgba(6, 6, 6, .7);
    }

    .marketBoard {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    .boardCard {
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(8, 8, 8, .9);
      padding: 10px 12px;
    }
    .boardHead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed rgba(86, 255, 168, .28);
      margin-bottom: 8px;
    }
    .boardTitle {
      font-size: 11px;
      letter-spacing: .2em;
      text-transform: uppercase;
    }
    .boardHint {
      font-size: 10px;
      letter-spacing: .16em;
      text-transform: uppercase;
      opacity: .6;
    }
    .boardRows {
      display: grid;
      gap: 6px;
    }
    .boardRow {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr) minmax(62px, 88px) auto auto;
      gap: 8px;
      align-items: center;
      font-size: 11px;
    }
    .boardSym {
      letter-spacing: .18em;
      text-transform: uppercase;
      opacity: .8;
    }
    .boardName {
      opacity: .7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .boardPx,
    .boardChg {
      font-variant-numeric: tabular-nums;
      text-align: right;
    }
    .boardSpark {
      width: 100%;
      height: 18px;
      overflow: visible;
      opacity: .92;
    }
    .boardSparkArea {
      fill: rgba(86, 255, 168, .12);
    }
    .boardSparkLine {
      fill: none;
      stroke: rgba(86, 255, 168, .85);
      stroke-width: 1.35;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .boardSpark[data-dir="is-dn"] .boardSparkArea {
      fill: rgba(255, 98, 122, .12);
    }
    .boardSpark[data-dir="is-dn"] .boardSparkLine {
      stroke: rgba(255, 98, 122, .9);
    }
    .boardSpark[data-dir="is-flat"] .boardSparkArea {
      fill: rgba(230, 246, 239, .08);
    }
    .boardSpark[data-dir="is-flat"] .boardSparkLine {
      stroke: rgba(230, 246, 239, .72);
    }
    .boardChg.is-up { color: rgba(86, 255, 168, .98); }
    .boardChg.is-dn { color: rgba(255, 98, 122, .95); }
    .boardChg.is-flat { color: rgba(230, 246, 239, .7); }
    .moverGrid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .moverList {
      display: grid;
      gap: 6px;
    }
    .moverRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(86, 255, 168, .18);
    }
    .moverRight {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .moverRow.is-shock {
      border-radius: 8px;
      border-bottom: 0;
      padding: 6px 8px;
      background: rgba(8, 8, 8, .9);
      border: 1px solid rgba(86, 255, 168, .22);
      box-shadow: inset 0 0 0 1px rgba(86, 255, 168, .06);
    }
    .moverRow.is-shock.is-up {
      border-color: rgba(86, 255, 168, .55);
      box-shadow: inset 0 0 0 1px rgba(86, 255, 168, .18), 0 0 14px rgba(86, 255, 168, .08);
    }
    .moverRow.is-shock.is-dn {
      border-color: rgba(255, 98, 122, .55);
      box-shadow: inset 0 0 0 1px rgba(255, 98, 122, .18), 0 0 14px rgba(255, 98, 122, .08);
    }
    .moverRow:last-child { border-bottom: 0; }
    .moverSym {
      letter-spacing: .16em;
      text-transform: uppercase;
      opacity: .75;
    }
    .moverName {
      flex: 1;
      margin-left: 8px;
      opacity: .7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .moverPct {
      font-variant-numeric: tabular-nums;
    }
    .moverPct.is-up { color: rgba(86, 255, 168, .98); }
    .moverPct.is-dn { color: rgba(255, 98, 122, .95); }
    .moverPct.is-flat { color: rgba(230, 246, 239, .7); }
    .termTable {
      border-radius: 10px;
      border: 1px solid rgba(86, 255, 168, .22);
      background: rgba(8, 8, 8, .92);
      padding: 10px 12px;
    }
    .termTableHead {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 8px;
      border-bottom: 1px dashed rgba(86, 255, 168, .28);
      margin-bottom: 8px;
    }
    .termTableTitle {
      font-size: 11px;
      letter-spacing: .2em;
      text-transform: uppercase;
    }
    .termTableHint {
      font-size: 10px;
      letter-spacing: .16em;
      text-transform: uppercase;
      opacity: .6;
    }
    .gridTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .gridTable th,
    .gridTable td {
      padding: 6px 6px;
      border-bottom: 1px dashed rgba(86, 255, 168, .18);
    }
    .gridTable th {
      text-align: left;
      font-weight: 600;
      letter-spacing: .16em;
      text-transform: uppercase;
      opacity: .7;
      font-size: 10px;
    }
    .gridTable tbody tr:hover {
      background: rgba(86, 255, 168, .06);
    }
    .cellSym {
      letter-spacing: .16em;
      text-transform: uppercase;
    }
    .cellPx,
    .cellChg {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .cellChg.is-up { color: rgba(86, 255, 168, .98); }
    .cellChg.is-dn { color: rgba(255, 98, 122, .95); }
    .cellChg.is-flat { color: rgba(230, 246, 239, .7); }

    @media (max-width: 1100px) {
      .terminalLayout { grid-template-columns: 1fr; }
      .terminalRail { position: static; }
      .signalGrid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .marketBoard { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .terminalTables { grid-template-columns: 1fr; }
      .moverGrid { grid-template-columns: 1fr; }
    }
    @media (max-width: 960px) {
      .overviewTop { grid-template-columns: 1fr; }
    }
    @media (max-width: 720px) {
      .terminalHead { flex-direction: column; align-items: flex-start; }
      .terminalRight { align-items: flex-start; }
      .kbdRow { justify-content: flex-start; }
      .signalGrid { grid-template-columns: 1fr; }
      .marketBoard { grid-template-columns: 1fr; }
      .boardRow { grid-template-columns: auto minmax(0, 1fr) minmax(54px, 70px) auto auto; }
    }

    @keyframes ticker-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    @keyframes news-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    @media (prefers-reduced-motion: reduce) {
      .tickerTrack,
      .newsTrack{
        animation: none;
      }
    }
  </style>
</head>

<body class="markets" data-view="overview">
  <a class="skip" href="#main">Skip to content</a>

  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <!-- Liberal Markets logo -->
        <svg viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg">
        <path d="m655.45 328.74v77.062-0.046875c0 9.375-7.5469 16.969-16.922 16.969h-77.062c-4.5 0-8.8125-1.7812-11.953-4.9688-3.1875-3.1875-4.9688-7.5-4.9688-12v-77.016c0-4.5 1.7812-8.8125 4.9688-12 3.1406-3.1875 7.4531-4.9688 11.953-4.9688h77.062c9.375 0 16.922 7.5938 16.922 16.969zm-279.94 0v77.062-0.046875c0 4.5-1.7812 8.8125-4.9688 12-3.1406 3.1875-7.4531 4.9688-11.953 4.9688h-78.656c-4.4531 0-8.7656-1.7812-11.953-4.9688s-4.9688-7.5-4.9219-12v-77.016c-0.046875-4.5 1.7344-8.8125 4.9219-12s7.5-4.9688 11.953-4.9688h78.656c4.5 0 8.8125 1.7812 11.953 4.9688 3.1875 3.1875 4.9688 7.5 4.9688 12zm488.29-99.094v-78.656c0-4.5 1.7812-8.7656 4.9219-11.953 3.1875-3.1875 7.5-4.9688 12-4.9688h215.44c9.375 0 16.922 7.5938 16.922 16.922v898.03c0 9.3281-7.5469 16.922-16.922 16.922h-215.44c-4.5 0-8.8125-1.7812-12-4.9688-3.1406-3.1875-4.9219-7.4531-4.9219-11.953v-77.016c0-9.3281 7.5469-16.922 16.922-16.922h119.91v-708.52h-119.91c-9.375 0-16.922-7.5938-16.922-16.922zm-664.45 725.39v-708.47h119.91c9.375 0 16.922-7.5938 16.922-16.922v-78.656c0-4.5-1.7812-8.7656-4.9219-11.953-3.1875-3.1875-7.5-4.9688-12-4.9688h-215.44c-9.375 0-16.922 7.5938-16.922 16.922v898.03c0 9.3281 7.5469 16.922 16.922 16.922h215.44c4.5 0 8.8125-1.7812 12-4.9688 3.1406-3.1875 4.9219-7.4531 4.9219-11.953v-77.016c0-9.3281-7.5469-16.922-16.922-16.922zm737.58-160.78 0.046875-0.046875c0-9.3281-7.5938-16.922-16.922-16.922h-78.656c-9.3281 0-16.922 7.5938-16.922 16.922v78.609c0 9.375 7.5938 16.922 16.922 16.969h78.656c9.3281 0 16.922-7.5938 16.922-16.969v-78.562zm-281.53 0v78.609l0.046875-0.046875c0 9.375-7.5469 16.969-16.922 16.969h-77.062c-4.5 0-8.8125-1.7812-11.953-4.9688-3.1875-3.1875-4.9688-7.5-4.9688-12v-78.562c0-4.5 1.7812-8.8125 4.9688-12 3.1406-3.1875 7.4531-4.9688 11.953-4.9688h77.062c9.375 0 16.922 7.5938 16.922 16.969zm-279.94 0v78.609l0.046875-0.046875c0 4.5-1.7812 8.8125-4.9688 12-3.1406 3.1875-7.4531 4.9688-11.953 4.9688h-78.656c-4.4531 0-8.7656-1.7812-11.953-4.9688s-4.9688-7.5-4.9219-12v-78.562c-0.046875-4.5 1.7344-8.8125 4.9219-12s7.5-4.9688 11.953-4.9688h78.656c4.5 0 8.8125 1.7812 11.953 4.9688 3.1875 3.1875 4.9688 7.5 4.9688 12zm561.47-232.78 0.046875-0.046874c0-4.5-1.7812-8.8125-4.9688-12-3.1875-3.1406-7.5-4.9219-11.953-4.9219h-78.656c-9.3281 0-16.922 7.5469-16.922 16.922v78.656-0.046876c0 9.375 7.5938 16.922 16.922 16.922h78.656c4.4531 0 8.7656-1.7812 11.953-4.9219 3.1875-3.1875 4.9688-7.5 4.9688-12v-78.562zm-281.53 0v78.656l0.046875-0.09375c0 4.5-1.7812 8.8125-4.9688 12-3.1406 3.1406-7.4531 4.9219-11.953 4.9219h-77.062c-9.3281 0-16.922-7.5469-16.922-16.922v-78.562c0-9.3281 7.5938-16.922 16.922-16.922h77.062c4.5 0 8.8125 1.7812 11.953 4.9688 3.1875 3.1406 4.9688 7.4531 4.9688 11.953zm-279.94 0v78.656l0.046875-0.09375c0 9.375-7.5938 16.922-16.922 16.922h-78.656c-9.3281 0-16.875-7.5469-16.875-16.922v-78.562c0-9.3281 7.5469-16.922 16.875-16.922h78.656c9.3281 0 16.922 7.5938 16.922 16.922zm561.47-232.78 0.046875-0.09375c0-9.3281-7.5938-16.922-16.922-16.922h-78.656c-9.3281 0-16.922 7.5938-16.922 16.922v77.062c0 9.3281 7.5938 16.922 16.922 16.922h78.656c9.3281 0 16.922-7.5469 16.922-16.922z" fill-rule="evenodd"/>
        </svg>
      </div>
      <div class="brandText">
        <div class="brandName">Liberal Markets</div>
        <div class="brandTag">market heatmap</div>
      </div>
    </div>

    <nav class="nav">
      <button class="chip" data-nav="all" type="button" aria-pressed="false">
        <span class="chipDot" aria-hidden="true"></span> Home
      </button>
      <button class="chip" data-nav="trumptracker" type="button" aria-pressed="false">
        <span class="chipDot" aria-hidden="true"></span> Trump Tracker
      </button>
      <button class="chip is-active" data-nav="markets" type="button" aria-pressed="true">
        <span class="chipDot" aria-hidden="true"></span> Markets
      </button>
      <button class="chip" data-nav="model" type="button" aria-pressed="false">
        <span class="chipDot" aria-hidden="true"></span> Model
      </button>
    </nav>

    <div class="actions">
      <label class="search" aria-label="Search posts">
        <span class="searchIcon" aria-hidden="true">
          <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M20 20l-3.2-3.2"></path>
          </svg>
        </span>
        <input id="q" type="search" placeholder="Search… (e.g., “yield”, “CPI”, “DCF”)" autocomplete="off" />
        <span class="kbd" aria-hidden="true">⌘+K</span>
      </label>

    </div>
  </header>

  <main id="main" class="wrap">
    <section class="terminalHead" aria-label="Terminal header">
      <div>
        <div class="terminalTitle">Markets Terminal</div>
        <div class="terminalMeta">
          <span class="statusDot" aria-hidden="true"></span>
          <span>Session: Global</span>
          <span>UTC <span id="termUtc">—</span></span>
          <span>Local <span id="termLocal">—</span></span>
          <span>Sync <span id="termSync">—</span></span>
        </div>
        <div class="sessionStrip" aria-label="Market sessions">
          <span class="sessionTitle">Sessions</span>
          <div class="sessionPill" id="sessionAsiaPill" data-state="closed">
            <span class="sessionDot" aria-hidden="true"></span>
            <span class="sessionName">Asia</span>
            <span class="sessionTime" id="sessionAsia">—</span>
            <span class="sessionState" id="sessionAsiaState">—</span>
          </div>
          <div class="sessionPill" id="sessionEuropePill" data-state="closed">
            <span class="sessionDot" aria-hidden="true"></span>
            <span class="sessionName">Europe</span>
            <span class="sessionTime" id="sessionEurope">—</span>
            <span class="sessionState" id="sessionEuropeState">—</span>
          </div>
          <div class="sessionPill" id="sessionUsPill" data-state="closed">
            <span class="sessionDot" aria-hidden="true"></span>
            <span class="sessionName">US</span>
            <span class="sessionTime" id="sessionUs">—</span>
            <span class="sessionState" id="sessionUsState">—</span>
          </div>
        </div>
      </div>
      <div class="terminalRight">
        <div class="marketClock" aria-label="Market clock">
          <div class="clockRing" id="clockRing" aria-hidden="true"></div>
          <div class="clockLabel" id="clockLabel">—</div>
        </div>
        <div class="kbdRow" aria-label="Terminal shortcuts">
          <button class="kbdKey js-view is-active" type="button" data-view="overview" aria-pressed="true">F1 Overview</button>
          <button class="kbdKey js-view" type="button" data-view="tables" aria-pressed="false">F2 Tables</button>
          <button class="kbdKey js-view" type="button" data-view="heatmap" aria-pressed="false">F3 Heatmap</button>
        </div>
        <div class="terminalHint">Cmd + K to filter</div>
      </div>
    </section>

    <section class="tickerStrip view-overview" aria-label="Market ticker">
      <div class="tickerLabel">TAPE</div>
      <div class="tickerMarquee" role="list">
        <div class="tickerTrack">
          <div class="tickerItem" role="listitem" data-sym="spy.us">
            <span class="tickerSym">SPY</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" role="listitem" data-sym="qqq.us">
            <span class="tickerSym">QQQ</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" role="listitem" data-sym="dia.us">
            <span class="tickerSym">DIA</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" role="listitem" data-sym="10yusy.b">
            <span class="tickerSym">10Y</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" role="listitem" data-sym="usdeur">
            <span class="tickerSym">EURUSD</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" role="listitem" data-sym="cb.f">
            <span class="tickerSym">BRENT</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" role="listitem" data-sym="xauusd">
            <span class="tickerSym">GOLD</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" role="listitem" data-sym="btc.v">
            <span class="tickerSym">BTC</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
        </div>
        <div class="tickerTrack" aria-hidden="true">
          <div class="tickerItem" data-sym="spy.us">
            <span class="tickerSym">SPY</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" data-sym="qqq.us">
            <span class="tickerSym">QQQ</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" data-sym="dia.us">
            <span class="tickerSym">DIA</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" data-sym="10yusy.b">
            <span class="tickerSym">10Y</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" data-sym="usdeur">
            <span class="tickerSym">EURUSD</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" data-sym="cb.f">
            <span class="tickerSym">BRENT</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" data-sym="xauusd">
            <span class="tickerSym">GOLD</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
          <div class="tickerItem" data-sym="btc.v">
            <span class="tickerSym">BTC</span>
            <span class="tickerPx js-price">—</span>
            <span class="tickerChg js-pct is-flat">—</span>
          </div>
        </div>
      </div>
    </section>

    <section class="newsTicker view-overview" aria-label="News ticker">
      <div class="newsLabel">NEWS</div>
      <div class="newsMarquee">
        <div class="newsTrack" id="newsTrack">
          <span class="newsItem">Loading headlines…</span>
        </div>
        <div class="newsTrack" id="newsTrackClone" aria-hidden="true">
          <span class="newsItem">Loading headlines…</span>
        </div>
      </div>
    </section>

    <div class="overviewTop view-overview">
      <section class="alertConsole" aria-label="Alert console">
        <div class="alertSummary">
          <div class="alertLabel">Alert Console</div>
          <div class="alertCount" id="alertCount">—</div>
          <div class="alertState" id="alertState">Syncing</div>
        </div>
        <div class="alertRows" id="alertRows">
          <div class="alertRow is-offline">
            <div class="alertTop">
              <span class="alertRule">Loading rules</span>
              <span class="alertStatus">WAIT</span>
            </div>
            <div class="alertReadouts">
              <span class="alertMeta">Fetching market data…</span>
            </div>
          </div>
        </div>
      </section>

      <section class="signalGrid" aria-label="Market signals">
        <div class="signalCard">
          <div class="signalLabel">Median Move</div>
          <div class="signalValue" id="sigMedian">—</div>
          <div class="signalMeta">Across symbols</div>
        </div>
        <div class="signalCard">
          <div class="signalLabel">Dispersion</div>
          <div class="signalValue" id="sigDisp">—</div>
          <div class="signalMeta">Std dev</div>
        </div>
        <div class="signalCard">
          <div class="signalLabel">Leaders</div>
          <div class="signalList">
            <div class="signalRow">
              <span class="signalKey">Top Up</span>
              <span class="signalVal" id="sigTopUp">—</span>
            </div>
            <div class="signalRow">
              <span class="signalKey">Top Dn</span>
              <span class="signalVal" id="sigTopDn">—</span>
            </div>
          </div>
          <div class="signalMeta">Heatmap</div>
        </div>
        <div class="signalCard">
          <div class="signalLabel">Risk Radar</div>
          <div class="riskRow">
            <div class="riskRing" id="riskRing" aria-hidden="true"></div>
            <div>
              <div class="riskValue" id="riskValue">—</div>
              <div class="riskNote" id="riskNote">Balanced</div>
            </div>
          </div>
          <div class="signalMeta">Breadth × Dispersion</div>
        </div>
      </section>
    </div>

    <div class="terminalLayout">
      <div class="terminalMain">

        <section class="corrCard view-overview" aria-label="Correlation matrix">
          <div class="termTableHead">
            <div class="termTableTitle">Correlation Matrix</div>
            <div class="termTableHint">Rolling returns</div>
          </div>
          <div class="corrWrap">
            <table class="corrTable" id="corrTable" role="table" aria-label="Rolling correlation matrix"></table>
          </div>
          <div class="corrMeta" id="corrMeta">Waiting for history…</div>
        </section>

        <section class="marketBoard view-overview" aria-label="Market board">
          <div class="boardCard">
            <div class="boardHead">
              <div class="boardTitle">Indices</div>
              <div class="boardHint">Global</div>
            </div>
            <div class="boardRows">
              <div class="boardRow" data-sym="spy.us">
                <span class="boardSym">SPY</span>
                <span class="boardName">S&amp;P 500</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="qqq.us">
                <span class="boardSym">QQQ</span>
                <span class="boardName">Nasdaq 100</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="^dax">
                <span class="boardSym">DAX</span>
                <span class="boardName">Germany</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="^ukx">
                <span class="boardSym">FTSE</span>
                <span class="boardName">UK 100</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
            </div>
          </div>
          <div class="boardCard">
            <div class="boardHead">
              <div>
                <div class="boardTitle">Rates</div>
                <div class="boardHint">Govt</div>
              </div>
              <div class="panelTabs" role="tablist" aria-label="Rates panels">
                <button class="panelTab is-active js-rate-tab" type="button" data-panel="rates" aria-pressed="true">Rates</button>
                <button class="panelTab js-rate-tab" type="button" data-panel="fx" aria-pressed="false">FX</button>
              </div>
            </div>
            <div class="boardRows js-rates-rows">
              <div class="boardRow" data-sym="2yusy.b">
                <span class="boardSym">2Y</span>
                <span class="boardName">US 2Y</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="5yusy.b">
                <span class="boardSym">5Y</span>
                <span class="boardName">US 5Y</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="10yusy.b">
                <span class="boardSym">10Y</span>
                <span class="boardName">US 10Y</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="30yusy.b">
                <span class="boardSym">30Y</span>
                <span class="boardName">US 30Y</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
            </div>
            <div class="boardRows js-fx-rows is-hidden">
              <div class="boardRow" data-sym="usdeur">
                <span class="boardSym">EUR</span>
                <span class="boardName">USD/EUR</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="usdjpy">
                <span class="boardSym">JPY</span>
                <span class="boardName">USD/JPY</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="usdcny">
                <span class="boardSym">CNY</span>
                <span class="boardName">USD/CNY</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="usdtwd">
                <span class="boardSym">TWD</span>
                <span class="boardName">USD/TWD</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
            </div>
          </div>
          <div class="boardCard">
            <div class="boardHead">
              <div class="boardTitle">Commodities</div>
              <div class="boardHint">Energy/Metals</div>
            </div>
            <div class="boardRows">
              <div class="boardRow" data-sym="cb.f">
                <span class="boardSym">BRENT</span>
                <span class="boardName">Oil</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="cl.f">
                <span class="boardSym">WTI</span>
                <span class="boardName">Crude</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="xauusd">
                <span class="boardSym">XAU</span>
                <span class="boardName">Gold</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="gc.f">
                <span class="boardSym">GC</span>
                <span class="boardName">Gold (Fut)</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="si.f">
                <span class="boardSym">SI</span>
                <span class="boardName">Silver</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="hg.f">
                <span class="boardSym">HG</span>
                <span class="boardName">Copper</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
            </div>
          </div>
          <div class="boardCard">
            <div class="boardHead">
              <div class="boardTitle">Crypto</div>
              <div class="boardHint">24h</div>
            </div>
            <div class="boardRows">
              <div class="boardRow" data-sym="btc.v">
                <span class="boardSym">BTC</span>
                <span class="boardName">Bitcoin</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="eth.v">
                <span class="boardSym">ETH</span>
                <span class="boardName">Ethereum</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="sol.v">
                <span class="boardSym">SOL</span>
                <span class="boardName">Solana</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="xrp.v">
                <span class="boardSym">XRP</span>
                <span class="boardName">XRP</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
              <div class="boardRow" data-sym="doge.v">
                <span class="boardSym">DOGE</span>
                <span class="boardName">Dogecoin</span>
                <span class="boardPx js-price">—</span>
                <span class="boardChg js-pct is-flat">—</span>
              </div>
            </div>
          </div>
        </section>

        <section class="moverGrid view-overview" aria-label="Top movers">
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Top Gainers</div>
          <div class="termTableHint">Top 5</div>
        </div>
        <div class="moverList" id="gainersList"></div>
      </div>
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Top Losers</div>
          <div class="termTableHint">Top 5</div>
        </div>
        <div class="moverList" id="losersList"></div>
      </div>
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Most Volatile</div>
          <div class="termTableHint">Abs move</div>
        </div>
        <div class="moverList" id="volList"></div>
      </div>
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Shock List</div>
          <div class="termTableHint">≥ 2% move</div>
        </div>
        <div class="moverList" id="shockList"></div>
      </div>
        </section>

        <section class="terminalTables view-tables" aria-label="Market tables">
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Major Indices</div>
          <div class="termTableHint">Close to close</div>
        </div>
        <table class="gridTable" role="table">
          <thead>
            <tr>
              <th>Sym</th>
              <th>Name</th>
              <th class="cellPx">Last</th>
              <th class="cellChg">Chg%</th>
            </tr>
          </thead>
          <tbody>
            <tr data-sym="spy.us">
              <td class="cellSym">SPY</td>
              <td>S&amp;P 500</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="qqq.us">
              <td class="cellSym">QQQ</td>
              <td>Nasdaq 100</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="iwm.us">
              <td class="cellSym">IWM</td>
              <td>Russell 2000</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="dia.us">
              <td class="cellSym">DIA</td>
              <td>Dow 30</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="^dax">
              <td class="cellSym">DAX</td>
              <td>Germany</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="^ukx">
              <td class="cellSym">FTSE</td>
              <td>UK 100</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Macro</div>
          <div class="termTableHint">Cross asset</div>
        </div>
        <table class="gridTable" role="table">
          <thead>
            <tr>
              <th>Sym</th>
              <th>Name</th>
              <th class="cellPx">Last</th>
              <th class="cellChg">Chg%</th>
            </tr>
          </thead>
          <tbody>
            <tr data-sym="2yusy.b">
              <td class="cellSym">2Y</td>
              <td>US 2Y</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="5yusy.b">
              <td class="cellSym">5Y</td>
              <td>US 5Y</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="10yusy.b">
              <td class="cellSym">10Y</td>
              <td>US 10Y</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="30yusy.b">
              <td class="cellSym">30Y</td>
              <td>US 30Y</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="usdeur">
              <td class="cellSym">EURUSD</td>
              <td>USD/EUR</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="usdjpy">
              <td class="cellSym">USDJPY</td>
              <td>USD/JPY</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="cb.f">
              <td class="cellSym">BRENT</td>
              <td>Brent Oil</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="xauusd">
              <td class="cellSym">GOLD</td>
              <td>Gold</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="si.f">
              <td class="cellSym">SILVER</td>
              <td>Silver</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Crypto</div>
          <div class="termTableHint">24h</div>
        </div>
        <table class="gridTable" role="table">
          <thead>
            <tr>
              <th>Sym</th>
              <th>Name</th>
              <th class="cellPx">Last</th>
              <th class="cellChg">Chg%</th>
            </tr>
          </thead>
          <tbody>
            <tr data-sym="btc.v">
              <td class="cellSym">BTC</td>
              <td>Bitcoin</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="eth.v">
              <td class="cellSym">ETH</td>
              <td>Ethereum</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="sol.v">
              <td class="cellSym">SOL</td>
              <td>Solana</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="xrp.v">
              <td class="cellSym">XRP</td>
              <td>XRP</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="doge.v">
              <td class="cellSym">DOGE</td>
              <td>Dogecoin</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Mega Caps</div>
          <div class="termTableHint">Close to close</div>
        </div>
        <table class="gridTable" role="table">
          <thead>
            <tr>
              <th>Sym</th>
              <th>Name</th>
              <th class="cellPx">Last</th>
              <th class="cellChg">Chg%</th>
            </tr>
          </thead>
          <tbody>
            <tr data-sym="aapl.us">
              <td class="cellSym">AAPL</td>
              <td>Apple</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="msft.us">
              <td class="cellSym">MSFT</td>
              <td>Microsoft</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="nvda.us">
              <td class="cellSym">NVDA</td>
              <td>Nvidia</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="amzn.us">
              <td class="cellSym">AMZN</td>
              <td>Amazon</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="googl.us">
              <td class="cellSym">GOOGL</td>
              <td>Alphabet</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="meta.us">
              <td class="cellSym">META</td>
              <td>Meta</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="termTable">
        <div class="termTableHead">
          <div class="termTableTitle">Sectors</div>
          <div class="termTableHint">SPDR</div>
        </div>
        <table class="gridTable" role="table">
          <thead>
            <tr>
              <th>Sym</th>
              <th>Name</th>
              <th class="cellPx">Last</th>
              <th class="cellChg">Chg%</th>
            </tr>
          </thead>
          <tbody>
            <tr data-sym="xlk.us">
              <td class="cellSym">XLK</td>
              <td>Tech</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="xlf.us">
              <td class="cellSym">XLF</td>
              <td>Financials</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="xle.us">
              <td class="cellSym">XLE</td>
              <td>Energy</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="xly.us">
              <td class="cellSym">XLY</td>
              <td>Consumer Disc</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="xlp.us">
              <td class="cellSym">XLP</td>
              <td>Staples</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
            <tr data-sym="xlv.us">
              <td class="cellSym">XLV</td>
              <td>Health Care</td>
              <td class="cellPx js-price">—</td>
              <td class="cellChg js-pct is-flat">—</td>
            </tr>
          </tbody>
        </table>
      </div>
        </section>

        <section class="hmSection view-heatmap" aria-label="Stock heatmap">
      <div class="hmHead">
        <div>
          <div class="hmKicker">MARKETS</div>
          <h2 class="hmTitle">Stock heatmap</h2>
          <p class="hmSub">Daily close-to-close moves, sourced from Stooq. Equal-size tiles because market-cap math on the client is how you get bugs and ulcers.</p>
        </div>
      </div>

      <div class="hmControlRow" aria-label="Heatmap controls">
        <div class="hmFilters" aria-label="Heatmap filters">
          <button class="hmChip js-hm-filter is-active" type="button" data-group="all" aria-pressed="true">All</button>
          <button class="hmChip js-hm-filter" type="button" data-group="index" aria-pressed="false">Index</button>
          <button class="hmChip js-hm-filter" type="button" data-group="mega" aria-pressed="false">Mega</button>
          <button class="hmChip js-hm-filter" type="button" data-group="large" aria-pressed="false">Large</button>
          <button class="hmChip js-hm-filter" type="button" data-group="sector" aria-pressed="false">Sector</button>
          <button class="hmChip js-hm-filter" type="button" data-group="macro" aria-pressed="false">Macro</button>
          <button class="hmChip js-hm-filter" type="button" data-group="crypto" aria-pressed="false">Crypto</button>
        </div>
        <div class="hmActions">
          <button class="hmToggle" id="hmSizeToggle" type="button" aria-pressed="false">Size by %</button>
          <button class="btn hmActionBtn" id="hmRefresh" type="button" title="Refresh heatmap">Refresh</button>
          <span class="hmStamp muted" id="hmStamp">Updated: —</span>
        </div>
      </div>

      <div class="hmGrid" id="hmGrid" role="list" aria-label="Heatmap tiles"></div>

      <div class="hmLegend" aria-label="Legend">
        <span class="muted">Legend:</span>
        <span><span class="hmSwatch hmDn3"></span> down big</span>
        <span><span class="hmSwatch hmDn2"></span> down</span>
        <span><span class="hmSwatch hmDn1"></span> slightly down</span>
        <span><span class="hmSwatch hmFlat"></span> flat</span>
        <span><span class="hmSwatch hmUp1"></span> slightly up</span>
        <span><span class="hmSwatch hmUp2"></span> up</span>
        <span><span class="hmSwatch hmUp3"></span> up big</span>
      </div>
        </section>
      </div>
      
    </div>


    <footer class="footer">
      <div class="footerLeft">
        <span class="footMark" aria-hidden="true"></span>
        <span>Liberal Markets</span>
        <span class="muted">© <span id="year"></span></span>
      </div>
      <div class="footerRight">
        <a class="footLink" href="#" id="exportBtn">Export pins</a>
        <span class="muted">No trackers. No noise.</span>
      </div>
    </footer>
  </main>

  <dialog class="modal" id="modal">
    <form method="dialog" class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">Quick Search</div>
        <button class="x" value="cancel" aria-label="Close">
          <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M6 6l12 12"></path>
            <path d="M18 6l-12 12"></path>
          </svg>
        </button>
      </div>

      <label class="modalSearch">
        <input id="modalQ" type="search" placeholder="Type to filter posts…" autocomplete="off" />
      </label>

      <div class="modalList" id="modalList"></div>

      <div class="modalFoot">
        <span class="muted">Enter opens. Esc closes. Humans remain complicated.</span>
      </div>
    </form>
  </dialog>

  <dialog class="modal" id="hotkeys">
    <form method="dialog" class="modalBox">
      <div class="modalHead">
        <div class="modalTitle">Keybinds</div>
        <button class="x" value="cancel" aria-label="Close">
          <svg viewBox="0 0 24 24" class="icon" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M6 6l12 12"></path>
            <path d="M18 6l-12 12"></path>
          </svg>
        </button>
      </div>
      <div class="hotkeysGrid">
        <div class="hotkeyRow"><span class="hotkeyKey">F1</span><span class="hotkeyDesc">Overview view</span></div>
        <div class="hotkeyRow"><span class="hotkeyKey">F2</span><span class="hotkeyDesc">Tables view</span></div>
        <div class="hotkeyRow"><span class="hotkeyKey">F3</span><span class="hotkeyDesc">Heatmap view</span></div>
        <div class="hotkeyRow"><span class="hotkeyKey">R</span><span class="hotkeyDesc">Toggle FX panel</span></div>
        <div class="hotkeyRow"><span class="hotkeyKey">?</span><span class="hotkeyDesc">Toggle help</span></div>
        <div class="hotkeyRow"><span class="hotkeyKey">⌘ + K</span><span class="hotkeyDesc">Search filter</span></div>
        <div class="hotkeyRow"><span class="hotkeyKey">Esc</span><span class="hotkeyDesc">Close panel</span></div>
      </div>
      <div class="modalFoot">
        <span class="muted">Tip: press ? anytime to see this panel.</span>
      </div>
    </form>
  </dialog>

  <script src="app.js?v=4"></script>
  <script src="scripts/chart.js?v=4"></script>
  <script>
    /**
     * Heatmap renderer (reads /heatmap.json generated by scripts/fetch-tape.mjs).
     * No direct Stooq client fetch because CORS is a thing that exists to ruin your day.
     */
    (function () {


    /**
     * Decide how to decorate the numeric value based on Stooq symbol suffix.
     * - *.us -> USD ($)
     * - *.b  -> percent (%)
     * - otherwise -> plain number (no symbol)
     *
     * @param {string} sym
     * @param {number} value
     * @returns {string}
     */
    function formatValueBySym(sym, value) {
    if (!Number.isFinite(value)) return "—";

    const s = String(sym ?? "").trim().toLowerCase();

    if (s.endsWith(".us")) {
        return `$${fmtPx(value)}`;
    }

    if (s.includes("hsi")) {
        return `HK$${fmtPx(value)}`;
    }

    if (s.includes("nkx")) {
        return `¥${fmtPx(value)}`;
    }

    if (s.includes("snx")) {
        return `₹${fmtPx(value)}`;
    }

    if (s.includes("dax")) {
        return `€${fmtPx(value)}`;
    }

    if (s.includes("ukx")) {
        return `£${fmtPx(value)}`;
    }
    
    if (s.endsWith(".b")) {
        // yields/rates typically come as already “4.17” meaning 4.17%
        return `${fmtPx(value)}%`;
    }

    // everything else: no symbol
    return fmtPx(value);
    }


      const grid = document.getElementById("hmGrid");
      const stamp = document.getElementById("hmStamp");
      const btn = document.getElementById("hmRefresh");
      const sizeToggle = document.getElementById("hmSizeToggle");
      const searchInput = document.getElementById("q");
      const termUtc = document.getElementById("termUtc");
      const termLocal = document.getElementById("termLocal");
      const termSync = document.getElementById("termSync");
      const sessionAsia = document.getElementById("sessionAsia");
      const sessionEurope = document.getElementById("sessionEurope");
      const sessionUs = document.getElementById("sessionUs");
      const sessionAsiaState = document.getElementById("sessionAsiaState");
      const sessionEuropeState = document.getElementById("sessionEuropeState");
      const sessionUsState = document.getElementById("sessionUsState");
      const sessionAsiaPill = document.getElementById("sessionAsiaPill");
      const sessionEuropePill = document.getElementById("sessionEuropePill");
      const sessionUsPill = document.getElementById("sessionUsPill");
      const clockRing = document.getElementById("clockRing");
      const clockLabel = document.getElementById("clockLabel");

      const sigMedian = document.getElementById("sigMedian");
      const sigDisp = document.getElementById("sigDisp");
      const sigTopUp = document.getElementById("sigTopUp");
      const sigTopDn = document.getElementById("sigTopDn");
      const riskRing = document.getElementById("riskRing");
      const riskValue = document.getElementById("riskValue");
      const riskNote = document.getElementById("riskNote");
      const gainersList = document.getElementById("gainersList");
      const losersList = document.getElementById("losersList");
      const volList = document.getElementById("volList");
      const shockList = document.getElementById("shockList");
      const newsTrack = document.getElementById("newsTrack");
      const newsTrackClone = document.getElementById("newsTrackClone");
      const alertRows = document.getElementById("alertRows");
      const alertCountEl = document.getElementById("alertCount");
      const alertStateEl = document.getElementById("alertState");
      const corrTable = document.getElementById("corrTable");
      const corrMeta = document.getElementById("corrMeta");
      const hotkeysDialog = document.getElementById("hotkeys");
      const rateTabs = Array.from(document.querySelectorAll(".js-rate-tab"));
      const ratesRows = document.querySelector(".js-rates-rows");
      const fxRows = document.querySelector(".js-fx-rows");
      const sparkNs = "http://www.w3.org/2000/svg";

      const corrUniverse = [
        { sym: "spy.us", label: "SPY" },
        { sym: "qqq.us", label: "QQQ" },
        { sym: "10yusy.b", label: "10Y" },
        { sym: "usdeur", label: "EURUSD" },
        { sym: "xauusd", label: "GOLD" },
        { sym: "btc.v", label: "BTC" },
      ];

      const alertRules = [
        {
          id: "10y",
          label: "10Y Yield Pressure",
          target: "10Y > 4.50%",
          sym: "10yusy.b",
          metric: "close",
          threshold: 4.5,
        },
        {
          id: "spy",
          label: "SPY Momentum Shock",
          target: "|SPY| > 1.5%",
          sym: "spy.us",
          metric: "absPct",
          threshold: 1.5,
        },
        {
          id: "brent",
          label: "Brent Supply Spike",
          target: "Brent > $90",
          sym: "cb.f",
          metric: "close",
          threshold: 90,
        },
        {
          id: "btc",
          label: "BTC Volatility Break",
          target: "|BTC| > 3.0%",
          sym: "btc.v",
          metric: "absPct",
          threshold: 3,
        },
      ];

      const headlineTagRules = [
        { label: "Crypto", re: /\b(bitcoin|crypto|ethereum|token|btc)\b/i },
        { label: "Rates", re: /\b(fed|federal reserve|powell|rate|yield|treasury|bond)\b/i },
        { label: "AI", re: /\b(ai|anthropic|model|software|chip)\b/i },
        { label: "Commod", re: /\b(oil|gold|mineral|commodity|rare earth)\b/i },
        { label: "FX", re: /\b(dollar|yuan|yen|euro|currency)\b/i },
        { label: "Macro", re: /\b(trump|tariff|china|beijing|india|election|inflation|jobs)\b/i },
        { label: "Equity", re: /\b(stock|shares|equity|etf|portfolio|earnings)\b/i },
      ];

      const viewButtons = Array.from(document.querySelectorAll(".js-view"));
      const viewKeyMap = {
        F1: "overview",
        F2: "tables",
        F3: "heatmap",
      };
      const allowedViews = new Set(Object.values(viewKeyMap));
      let viewPulseTimer = null;
      const ratePanels = new Set(["rates", "fx"]);

      function setRatesPanel(panel, persist = true) {
        if (!ratePanels.has(panel)) return;
        if (ratesRows) ratesRows.classList.toggle("is-hidden", panel !== "rates");
        if (fxRows) fxRows.classList.toggle("is-hidden", panel !== "fx");
        for (const tab of rateTabs) {
          const active = tab.dataset.panel === panel;
          tab.classList.toggle("is-active", active);
          tab.setAttribute("aria-pressed", active ? "true" : "false");
        }
        if (persist) {
          try {
            localStorage.setItem("lm_rates_panel", panel);
          } catch {
            // ignore storage errors
          }
        }
      }

      function isTypingTarget(el) {
        if (!(el instanceof HTMLElement)) return false;
        const tag = el.tagName;
        return el.isContentEditable || tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT";
      }

      function setView(view, persist = true) {
        if (!view) return;
        document.body.setAttribute("data-view", view);
        for (const btn of viewButtons) {
          const active = btn.dataset.view === view;
          btn.classList.toggle("is-active", active);
          btn.setAttribute("aria-pressed", active ? "true" : "false");
        }
        for (const btn of viewButtons) {
          btn.classList.remove("is-pulse");
        }
        const activeBtn = viewButtons.find((btn) => btn.dataset.view === view);
        if (activeBtn) {
          activeBtn.classList.add("is-pulse");
          if (viewPulseTimer) clearTimeout(viewPulseTimer);
          viewPulseTimer = setTimeout(() => {
            activeBtn.classList.remove("is-pulse");
          }, 900);
        }
        if (persist) {
          try {
            localStorage.setItem("lm_view", view);
          } catch {
            // ignore storage errors
          }
        }
      }

      const savedView = (() => {
        try {
          return localStorage.getItem("lm_view");
        } catch {
          return null;
        }
      })();
      if (savedView && allowedViews.has(savedView)) setView(savedView, false);

      const savedPanel = (() => {
        try {
          return localStorage.getItem("lm_rates_panel");
        } catch {
          return null;
        }
      })();
      if (savedPanel && ratePanels.has(savedPanel)) setRatesPanel(savedPanel, false);

      for (const btn of viewButtons) {
        btn.addEventListener("click", () => {
          const view = btn.dataset.view;
          if (view) setView(view);
        });
      }
      for (const tab of rateTabs) {
        tab.addEventListener("click", () => {
          const panel = tab.dataset.panel;
          if (panel) setRatesPanel(panel);
        });
      }
      function toggleHotkeys(force) {
        if (!(hotkeysDialog instanceof HTMLDialogElement)) return;
        if (force === true) {
          if (!hotkeysDialog.open) hotkeysDialog.showModal();
          return;
        }
        if (force === false) {
          if (hotkeysDialog.open) hotkeysDialog.close();
          return;
        }
        if (hotkeysDialog.open) hotkeysDialog.close();
        else hotkeysDialog.showModal();
      }

      document.addEventListener("keydown", (e) => {
        if (isTypingTarget(e.target)) return;
        if (e.key === "?") {
          e.preventDefault();
          toggleHotkeys();
          return;
        }
        if (e.key === "Escape") {
          toggleHotkeys(false);
          return;
        }
        if (e.key === "r" || e.key === "R") {
          e.preventDefault();
          const active = rateTabs.find((tab) => tab.classList.contains("is-active"))?.dataset.panel;
          const next = active === "fx" ? "rates" : "fx";
          setRatesPanel(next);
          return;
        }
        const view = viewKeyMap[e.key];
        if (!view) return;
        e.preventDefault();
        setView(view);
      });

      if (!grid || !stamp || !btn) return;
      ensureBoardSparkSlots();

      // Heatmap state so we can re-sort without re-fetching.
      const hmState = {
        baseItems: /** @type {Array<any>} */ ([]),
        generatedAt: /** @type {string|null} */ (null),
      };
      const hmFilterButtons = Array.from(document.querySelectorAll(".js-hm-filter"));
      const hmGroupOrder = [
        { key: "index", label: "Index" },
        { key: "mega", label: "Mega" },
        { key: "large", label: "Large" },
        { key: "sector", label: "Sector" },
        { key: "macro", label: "Macro" },
        { key: "crypto", label: "Crypto" },
      ];
      const hmAllowedGroups = new Set(["all", ...hmGroupOrder.map((g) => g.key)]);
      let hmGroup = "all";
      let hmSizeMode = false;

      function updateSizeModeClasses() {
        if (grid) grid.classList.toggle("is-sized", hmSizeMode && hmGroup !== "all");
        if (grid) grid.classList.toggle("is-focus", hmGroup !== "all");
        document.querySelectorAll(".hmGroupGrid").forEach((el) => {
          el.classList.toggle("is-sized", hmSizeMode);
        });
      }

      function setHmGroup(group, persist = true) {
        if (!hmAllowedGroups.has(group)) return;
        hmGroup = group;
        for (const btn of hmFilterButtons) {
          const active = btn.dataset.group === group;
          btn.classList.toggle("is-active", active);
          btn.setAttribute("aria-pressed", active ? "true" : "false");
        }
        if (persist) {
          try {
            localStorage.setItem("lm_hm_group", group);
          } catch {
            // ignore storage errors
          }
        }
        updateSizeModeClasses();
        applyHeatmapQuery();
      }

      function setHmSizeMode(on, persist = true) {
        hmSizeMode = Boolean(on);
        updateSizeModeClasses();
        if (sizeToggle) {
          sizeToggle.classList.toggle("is-active", hmSizeMode);
          sizeToggle.setAttribute("aria-pressed", hmSizeMode ? "true" : "false");
          sizeToggle.textContent = hmSizeMode ? "Equal size" : "Size by %";
        }
        if (persist) {
          try {
            localStorage.setItem("lm_hm_size", hmSizeMode ? "1" : "0");
          } catch {
            // ignore storage errors
          }
        }
        applyHeatmapQuery();
      }

      function groupKeyFor(it) {
        return String(it?.group ?? "").trim().toLowerCase();
      }

      function sortItems(list, tokens) {
        const ranked = list.map((it, idx) => ({ it, idx, score: scoreItem(it, tokens) }));
        ranked.sort((a, b) => {
          if (!tokens.length) return a.idx - b.idx;
          if (b.score !== a.score) return b.score - a.score;
          return a.idx - b.idx;
        });
        return ranked.map((r) => r.it);
      }

      const savedGroup = (() => {
        try {
          return localStorage.getItem("lm_hm_group");
        } catch {
          return null;
        }
      })();
      if (savedGroup && hmAllowedGroups.has(savedGroup)) setHmGroup(savedGroup, false);

      const savedSize = (() => {
        try {
          return localStorage.getItem("lm_hm_size");
        } catch {
          return null;
        }
      })();
      if (savedSize === "1") setHmSizeMode(true, false);

      for (const chip of hmFilterButtons) {
        chip.addEventListener("click", () => {
          const group = chip.dataset.group;
          if (group) setHmGroup(group);
        });
      }
      if (sizeToggle) {
        sizeToggle.addEventListener("click", () => {
          setHmSizeMode(!hmSizeMode);
        });
      }

      function fmtTime(date, timeZone) {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) return "—";
        try {
          const opts = {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          };
          if (timeZone) opts.timeZone = timeZone;
          return date.toLocaleTimeString("en-US", opts);
        } catch {
          return date.toTimeString().slice(0, 8);
        }
      }

      function fmtTimeShort(date, timeZone) {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) return "—";
        try {
          const opts = {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          };
          if (timeZone) opts.timeZone = timeZone;
          return date.toLocaleTimeString("en-US", opts);
        } catch {
          return date.toTimeString().slice(0, 5);
        }
      }

      function fmtDateShort(iso) {
        if (!iso) return "—";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "—";
        return d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
      }

      function getZoneParts(timeZone) {
        const now = new Date();
        const parts = new Intl.DateTimeFormat("en-US", {
          timeZone,
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          weekday: "short",
        }).formatToParts(now);
        const get = (t) => parts.find((p) => p.type === t)?.value;
        const hour = Number(get("hour"));
        const minute = Number(get("minute"));
        const weekday = get("weekday") || "";
        if (!Number.isFinite(hour) || !Number.isFinite(minute)) return null;
        return { minutes: hour * 60 + minute, weekday };
      }

      function sessionState(nowMin, weekday, schedule) {
        if (nowMin == null) return "closed";
        if (weekday === "Sat" || weekday === "Sun") return "closed";

        const {
          open,
          close,
          preStart,
          preEnd,
          lunchStart,
          lunchEnd,
          afterStart,
          afterEnd,
        } = schedule;

        if (Number.isFinite(lunchStart) && Number.isFinite(lunchEnd)) {
          if (nowMin >= lunchStart && nowMin < lunchEnd) return "lunch";
        }
        if (nowMin >= open && nowMin < close) return "open";
        if (Number.isFinite(preStart) && Number.isFinite(preEnd)) {
          if (nowMin >= preStart && nowMin < preEnd) return "pre";
        }
        if (Number.isFinite(afterStart) && Number.isFinite(afterEnd)) {
          if (nowMin >= afterStart && nowMin < afterEnd) return "after";
        }
        return "closed";
      }

      function updateSessions() {
        const sessions = [
          {
            tz: "Asia/Tokyo",
            schedule: {
              preStart: 8 * 60,
              preEnd: 9 * 60,
              open: 9 * 60,
              lunchStart: 11 * 60 + 30,
              lunchEnd: 12 * 60 + 30,
              close: 15 * 60,
              afterStart: 15 * 60,
              afterEnd: 16 * 60,
            },
            timeEl: sessionAsia,
            stateEl: sessionAsiaState,
            pillEl: sessionAsiaPill,
          },
          {
            tz: "Europe/London",
            schedule: {
              preStart: 7 * 60,
              preEnd: 8 * 60,
              open: 8 * 60,
              close: 16 * 60 + 30,
              afterStart: 16 * 60 + 30,
              afterEnd: 17 * 60 + 30,
            },
            timeEl: sessionEurope,
            stateEl: sessionEuropeState,
            pillEl: sessionEuropePill,
          },
          {
            tz: "America/New_York",
            schedule: {
              preStart: 4 * 60,
              preEnd: 9 * 60 + 30,
              open: 9 * 60 + 30,
              close: 16 * 60,
              afterStart: 16 * 60,
              afterEnd: 20 * 60,
            },
            timeEl: sessionUs,
            stateEl: sessionUsState,
            pillEl: sessionUsPill,
          },
        ];

        const now = new Date();
        for (const s of sessions) {
          const parts = getZoneParts(s.tz);
          const minutes = parts?.minutes ?? null;
          const weekday = parts?.weekday ?? "";
          const state = sessionState(minutes, weekday, s.schedule);
          if (s.timeEl) s.timeEl.textContent = fmtTimeShort(now, s.tz);
          if (s.stateEl) s.stateEl.textContent = state.toUpperCase();
          if (s.pillEl) s.pillEl.setAttribute("data-state", state);
        }
      }

      function updateClockRing(now) {
        if (!(clockRing instanceof HTMLElement) || !(clockLabel instanceof HTMLElement)) return;
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const total = hours * 60 + minutes;
        const angle = Math.round((total / 1440) * 360);
        clockRing.style.background = `conic-gradient(rgba(86, 255, 168, .9) 0deg ${angle}deg, rgba(86, 255, 168, .12) ${angle}deg 360deg)`;
        clockLabel.textContent = `Local ${fmtTimeShort(now)}`;
      }

      function updateClocks() {
        const now = new Date();
        if (termUtc) termUtc.textContent = fmtTime(now, "UTC");
        if (termLocal) termLocal.textContent = fmtTime(now);
        updateSessions();
        updateClockRing(now);
      }

      function updateTermSync(ts) {
        if (!termSync) return;
        const d = ts ? new Date(ts) : null;
        termSync.textContent = d && !Number.isNaN(d.getTime()) ? fmtTime(d) : "—";
      }

      /**
       * Get the current query string from the top search box.
       * @returns {string}
       */
      function getHeatmapQuery() {
        return String(searchInput?.value ?? "").trim();
      }

      /**
       * Map percent change into a subtle color band.
       * @param {number} pct
       * @returns {string}
       */
      function bandClass(pct) {
        if (!Number.isFinite(pct)) return "hmFlat";
        if (pct <= -2.0) return "hmDn3";
        if (pct <= -1.0) return "hmDn2";
        if (pct <= -0.25) return "hmDn1";
        if (pct < 0.25) return "hmFlat";
        if (pct < 1.0) return "hmUp1";
        if (pct < 2.0) return "hmUp2";
        return "hmUp3";
      }

    function pctDirClass(pct) {
        if (!Number.isFinite(pct)) return "is-flat";
        if (pct > 0.05) return "is-up";
        if (pct < -0.05) return "is-dn";
        return "is-flat";
      }

      /**
       * Format a percent change.
       * @param {number} pct
       * @returns {string}
       */
      function fmtPct(pct) {
        if (!Number.isFinite(pct)) return "—";
        const sign = pct > 0 ? "+" : "";
        return `${sign}${pct.toFixed(2)}%`;
      }

      /**
       * Format price (keep it simple and readable).
       * @param {number} px
       * @returns {string}
       */
      function fmtPx(px) {
        if (!Number.isFinite(px)) return "—";
        if (Math.abs(px) >= 1000) return px.toFixed(0);
        if (Math.abs(px) >= 100) return px.toFixed(1);
        return px.toFixed(2);
      }

      function clampNum(n, min, max) {
        return Math.min(max, Math.max(min, n));
      }

      function normalizeHistory(it) {
        const rows = Array.isArray(it?.history) ? it.history : [];
        const parsed = rows
          .map((row) => ({
            date: String(row?.date ?? "").trim(),
            close: Number(row?.close),
          }))
          .filter((row) => row.date && Number.isFinite(row.close))
          .sort((a, b) => a.date.localeCompare(b.date));

        if (parsed.length) return parsed;

        const date = String(it?.date ?? "").trim();
        const prevDate = String(it?.prevDate ?? "").trim();
        const close = Number(it?.close);
        const prevClose = Number(it?.prevClose);
        const fallback = [];
        if (prevDate && Number.isFinite(prevClose)) fallback.push({ date: prevDate, close: prevClose });
        if (date && Number.isFinite(close)) fallback.push({ date, close });
        return fallback;
      }

      function historyToReturns(history) {
        const out = [];
        for (let i = 1; i < history.length; i++) {
          const prev = Number(history[i - 1]?.close);
          const cur = Number(history[i]?.close);
          if (!Number.isFinite(prev) || !Number.isFinite(cur) || prev === 0) continue;
          out.push({
            date: String(history[i]?.date ?? ""),
            ret: ((cur / prev) - 1) * 100,
          });
        }
        return out;
      }

      function pearsonCorrelation(valuesA, valuesB) {
        if (!Array.isArray(valuesA) || !Array.isArray(valuesB) || valuesA.length !== valuesB.length) return null;
        if (valuesA.length < 2) return null;
        const n = valuesA.length;
        const meanA = valuesA.reduce((a, b) => a + b, 0) / n;
        const meanB = valuesB.reduce((a, b) => a + b, 0) / n;
        let cov = 0;
        let varA = 0;
        let varB = 0;
        for (let i = 0; i < n; i++) {
          const da = valuesA[i] - meanA;
          const db = valuesB[i] - meanB;
          cov += da * db;
          varA += da * da;
          varB += db * db;
        }
        if (varA === 0 || varB === 0) return null;
        return cov / Math.sqrt(varA * varB);
      }

      function buildCorrelationPair(seriesA, seriesB, window = 20) {
        const mapB = new Map(seriesB.map((row) => [row.date, row.ret]));
        const pairs = [];
        for (const rowA of seriesA) {
          const b = mapB.get(rowA.date);
          if (!Number.isFinite(rowA.ret) || !Number.isFinite(b)) continue;
          pairs.push([rowA.ret, b]);
        }
        const tail = pairs.slice(-window);
        if (tail.length < 8) return { value: null, n: tail.length };
        const a = tail.map((row) => row[0]);
        const b = tail.map((row) => row[1]);
        return { value: pearsonCorrelation(a, b), n: tail.length };
      }

      function corrCellClass(v) {
        if (!Number.isFinite(v)) return "is-weak";
        if (v <= -0.25) return "is-neg";
        if (v >= 0.65) return "is-hi";
        if (v >= 0.35) return "is-mid";
        return "is-weak";
      }

      function headlineTagsFor(title) {
        const tags = [];
        if (/\b(surge|slashed|plung|crisis|meltdown|sell off|bear market)\b/i.test(title)) {
          tags.push({ label: "Vol", hot: true });
        }
        for (const rule of headlineTagRules) {
          if (!rule.re.test(title)) continue;
          tags.push({ label: rule.label, hot: false });
        }
        const seen = new Set();
        const deduped = [];
        for (const tag of tags) {
          const key = tag.label.toLowerCase();
          if (seen.has(key)) continue;
          seen.add(key);
          deduped.push(tag);
          if (deduped.length >= 2) break;
        }
        return deduped;
      }

      function latestHistoryValues(it, maxPoints = 24) {
        const points = normalizeHistory(it);
        if (!points.length) return [];
        return points.slice(-maxPoints).map((row) => row.close);
      }

      function sparkPathFromValues(values, width, height, pad = 1) {
        if (!Array.isArray(values) || values.length < 2) return null;
        const min = Math.min(...values);
        const max = Math.max(...values);
        const span = max - min || 1;
        const w = Math.max(1, width - pad * 2);
        const h = Math.max(1, height - pad * 2);
        const step = values.length > 1 ? w / (values.length - 1) : 0;

        const points = values.map((v, idx) => {
          const x = pad + idx * step;
          const y = pad + (1 - (v - min) / span) * h;
          return { x, y };
        });

        const line = points
          .map((p, idx) => `${idx === 0 ? "M" : "L"}${p.x.toFixed(2)} ${p.y.toFixed(2)}`)
          .join(" ");

        const baseline = (pad + h).toFixed(2);
        const area =
          `${line} L${points[points.length - 1].x.toFixed(2)} ${baseline} ` +
          `L${points[0].x.toFixed(2)} ${baseline} Z`;

        return { line, area };
      }

      function drawSparkline(svg, values, dirClass) {
        if (!(svg instanceof SVGElement)) return;
        const line = svg.querySelector(".boardSparkLine");
        const area = svg.querySelector(".boardSparkArea");
        if (!(line instanceof SVGPathElement) || !(area instanceof SVGPathElement)) return;

        const safeVals = values.filter((v) => Number.isFinite(v));
        const path = sparkPathFromValues(safeVals, 88, 18, 1);
        if (!path) {
          line.setAttribute("d", "");
          area.setAttribute("d", "");
          svg.dataset.dir = "is-flat";
          return;
        }

        line.setAttribute("d", path.line);
        area.setAttribute("d", path.area);
        svg.dataset.dir = dirClass || "is-flat";
      }

      function ensureBoardSparkSlots() {
        document.querySelectorAll(".boardRow").forEach((row) => {
          if (row.querySelector(".js-spark")) return;
          const spark = document.createElementNS(sparkNs, "svg");
          spark.classList.add("boardSpark", "js-spark");
          spark.setAttribute("viewBox", "0 0 88 18");
          spark.setAttribute("preserveAspectRatio", "none");
          spark.setAttribute("aria-hidden", "true");

          const area = document.createElementNS(sparkNs, "path");
          area.setAttribute("class", "boardSparkArea");
          const line = document.createElementNS(sparkNs, "path");
          line.setAttribute("class", "boardSparkLine");
          spark.appendChild(area);
          spark.appendChild(line);

          const price = row.querySelector(".boardPx");
          if (price) row.insertBefore(spark, price);
          else row.appendChild(spark);
        });
      }

      function evaluateAlert(rule, it) {
        const close = Number(it?.close);
        const pct = Number(it?.deltaPct);
        const threshold = Number(rule?.threshold);
        const metricName = String(rule?.metric ?? "");

        if (!Number.isFinite(threshold) || threshold <= 0) {
          return {
            state: "offline",
            ratio: 0,
            triggered: false,
            valueText: "No metric",
            pctClass: "is-flat",
            pctText: "—",
          };
        }

        const metric = metricName === "absPct" ? Math.abs(pct) : close;
        if (!Number.isFinite(metric)) {
          return {
            state: "offline",
            ratio: 0,
            triggered: false,
            valueText: "No data",
            pctClass: "is-flat",
            pctText: "—",
          };
        }

        const ratio = clampNum(metric / threshold, 0, 1.4);
        const triggered = ratio >= 1;
        const state = triggered ? "live" : ratio >= 0.82 ? "watch" : "idle";
        const valueText = metricName === "absPct"
          ? `|Δ| ${fmtPct(metric)}`
          : formatValueBySym(rule.sym, close);

        return {
          state,
          ratio,
          triggered,
          valueText,
          pctClass: pctDirClass(pct),
          pctText: Number.isFinite(pct) ? fmtPct(pct) : "—",
        };
      }

      function renderAlertConsole(items) {
        if (!alertRows) return;
        const map = new Map();
        for (const it of items) {
          const key = String(it?.sym ?? "").trim().toLowerCase();
          if (key) map.set(key, it);
        }

        let triggeredCount = 0;

        const rows = alertRules.map((rule) => {
          const it = map.get(rule.sym);
          const result = evaluateAlert(rule, it);
          if (result.triggered) triggeredCount += 1;

          const rowClass =
            result.state === "live" ? "is-live" :
            result.state === "watch" ? "is-watch" :
            result.state === "offline" ? "is-offline" :
            "";
          const statusText =
            result.state === "live" ? "LIVE" :
            result.state === "watch" ? "WATCH" :
            result.state === "offline" ? "OFFLINE" :
            "IDLE";

          return `
            <div class="alertRow ${rowClass}">
              <div class="alertTop">
                <span class="alertRule">${escapeHtml(rule.label)}</span>
                <span class="alertStatus">${statusText}</span>
              </div>
              <div class="alertReadouts">
                <span class="alertValue">${escapeHtml(result.valueText)}</span>
                <span class="alertDelta ${result.pctClass}">${escapeHtml(result.pctText)}</span>
                <span class="alertMeta">${escapeHtml(rule.target)}</span>
              </div>
              <div class="alertMeter"><span class="alertFill" style="width:${Math.round(clampNum(result.ratio * 100, 0, 100))}%"></span></div>
            </div>
          `;
        });

        alertRows.innerHTML = rows.join("");
        if (alertCountEl) {
          alertCountEl.textContent = `${triggeredCount}/${alertRules.length}`;
        }
        if (alertStateEl) {
          alertStateEl.textContent = triggeredCount
            ? `${triggeredCount} active trigger${triggeredCount > 1 ? "s" : ""}`
            : "No active triggers";
        }
      }

      function renderCorrelationMatrix(items) {
        if (!corrTable) return;
        const map = new Map();
        for (const it of items) {
          const key = String(it?.sym ?? "").trim().toLowerCase();
          if (key) map.set(key, it);
        }

        const rows = corrUniverse
          .map((entry) => {
            const it = map.get(entry.sym);
            const history = normalizeHistory(it);
            const returns = historyToReturns(history);
            return {
              ...entry,
              returns,
            };
          })
          .filter((row) => row.returns.length >= 2);

        if (rows.length < 2) {
          corrTable.innerHTML = `
            <thead><tr><th>Pair</th><th>Status</th></tr></thead>
            <tbody><tr><td class="corrRowHead">Matrix</td><td class="corrCell is-weak">Need more history</td></tr></tbody>
          `;
          if (corrMeta) corrMeta.textContent = "Rolling 20-day correlation needs symbols with history arrays.";
          return;
        }

        const overlaps = [];
        const head = rows.map((r) => `<th>${r.label}</th>`).join("");
        const body = rows
          .map((rowA, i) => {
            const cells = rows
              .map((rowB, j) => {
                if (i === j) {
                  return `<td class="corrCell is-hi" title="Same asset">1.00</td>`;
                }
                const pair = buildCorrelationPair(rowA.returns, rowB.returns, 20);
                overlaps.push(pair.n);
                const value = pair.value;
                const text = Number.isFinite(value) ? value.toFixed(2) : "—";
                const klass = corrCellClass(value);
                const tip = pair.n ? `Overlap: ${pair.n} sessions` : "No overlap";
                return `<td class="corrCell ${klass}" title="${tip}">${text}</td>`;
              })
              .join("");
            return `<tr><th class="corrRowHead">${rowA.label}</th>${cells}</tr>`;
          })
          .join("");

        corrTable.innerHTML = `
          <thead><tr><th></th>${head}</tr></thead>
          <tbody>${body}</tbody>
        `;

        if (corrMeta) {
          const avg = overlaps.length
            ? Math.round(overlaps.reduce((a, b) => a + b, 0) / overlaps.length)
            : 0;
          corrMeta.textContent = `Computed on overlapping daily returns (up to 20 sessions, avg overlap ${avg}).`;
        }
      }

      function updateSymbolBindings(items) {
        if (!Array.isArray(items) || !items.length) return;
        const map = new Map();
        for (const it of items) {
          const key = String(it?.sym ?? "").trim().toLowerCase();
          if (key) map.set(key, it);
        }

        document.querySelectorAll("[data-sym]").forEach((node) => {
          const key = String(node.getAttribute("data-sym") ?? "").trim().toLowerCase();
          const it = map.get(key);
          if (!it) return;

          const pct = Number(it.deltaPct);
          const close = Number(it.close);
          const ok = it.ok !== false && Number.isFinite(pct) && Number.isFinite(close);

          const priceText = ok ? formatValueBySym(it.sym, close) : "—";
          const pctText = ok ? fmtPct(pct) : "—";

          node.querySelectorAll(".js-price").forEach((el) => {
            el.textContent = priceText;
          });
          node.querySelectorAll(".js-pct").forEach((el) => {
            el.textContent = pctText;
            el.classList.remove("is-up", "is-dn", "is-flat");
            el.classList.add(pctDirClass(pct));
          });

          if (node.classList.contains("boardRow")) {
            const spark = node.querySelector(".js-spark");
            drawSparkline(spark, latestHistoryValues(it, 24), pctDirClass(pct));
          }
        });
      }

      function updateSignalBlocks(items) {
        if (!Array.isArray(items)) return;
        const deltas = items
          .map((it) => Number(it.deltaPct))
          .filter((v) => Number.isFinite(v))
          .sort((a, b) => a - b);

        if (!deltas.length) {
          if (sigMedian) sigMedian.textContent = "—";
          if (sigDisp) sigDisp.textContent = "—";
          if (sigTopUp) sigTopUp.textContent = "—";
          if (sigTopDn) sigTopDn.textContent = "—";
          if (riskValue) riskValue.textContent = "—";
          if (riskNote) riskNote.textContent = "No data";
          return;
        }

        const adv = deltas.filter((v) => v > 0.05).length;
        const dec = deltas.filter((v) => v < -0.05).length;
        const active = adv + dec;
        const breadth = active ? (adv / active) * 100 : 0;

        const mid = Math.floor(deltas.length / 2);
        const median = deltas.length % 2 ? deltas[mid] : (deltas[mid - 1] + deltas[mid]) / 2;
        const mean = deltas.reduce((a, b) => a + b, 0) / deltas.length;
        const variance = deltas.reduce((a, b) => a + (b - mean) ** 2, 0) / deltas.length;
        const stdev = Math.sqrt(variance);

        let topUp = null;
        let topDn = null;
        for (const it of items) {
          const pct = Number(it.deltaPct);
          if (!Number.isFinite(pct)) continue;
          if (!topUp || pct > topUp.pct) topUp = { sym: it.sym, pct };
          if (!topDn || pct < topDn.pct) topDn = { sym: it.sym, pct };
        }

        if (sigMedian) sigMedian.textContent = fmtPct(median);
        if (sigDisp) sigDisp.textContent = `${stdev.toFixed(2)}%`;
        if (sigTopUp) sigTopUp.textContent = topUp ? `${String(topUp.sym ?? "").toUpperCase()} ${fmtPct(topUp.pct)}` : "—";
        if (sigTopDn) sigTopDn.textContent = topDn ? `${String(topDn.sym ?? "").toUpperCase()} ${fmtPct(topDn.pct)}` : "—";

        const breadthBias = Math.abs(breadth - 50) / 50;
        const volNorm = clampNum(stdev / 2.5, 0, 1);
        const risk = clampNum(volNorm * 0.65 + breadthBias * 0.35, 0, 1);
        const riskPct = Math.round(risk * 100);
        const angle = Math.round(risk * 360);
        const riskColor =
          risk >= 0.66 ? "rgba(255, 98, 122, .9)" :
          risk >= 0.33 ? "rgba(255, 198, 86, .9)" :
          "rgba(86, 255, 168, .9)";

        if (riskRing) {
          riskRing.style.background = `conic-gradient(${riskColor} 0deg ${angle}deg, rgba(86, 255, 168, .12) ${angle}deg 360deg)`;
        }
        if (riskValue) riskValue.textContent = `${riskPct}%`;
        if (riskNote) {
          riskNote.textContent = risk >= 0.66 ? "Hot" : risk >= 0.33 ? "Active" : "Calm";
        }
      }


      function renderMoverList(el, rows) {
        if (!el) return;
        if (!rows.length) {
          el.innerHTML = "<div class=\"moverRow\"><span class=\"moverSym\">—</span><span class=\"moverName\">No data</span><span class=\"moverPct is-flat\">—</span></div>";
          return;
        }
        el.innerHTML = rows.map((row) => {
          const pctClass = pctDirClass(row.pct);
          return `
            <div class="moverRow">
              <span class="moverSym">${row.sym}</span>
              <span class="moverName">${row.name}</span>
              <span class="moverPct ${pctClass}">${fmtPct(row.pct)}</span>
            </div>
          `;
        }).join("");
      }

      function renderShockList(el, rows) {
        if (!el) return;
        if (!rows.length) {
          el.innerHTML = "<div class=\"moverRow\"><span class=\"moverSym\">—</span><span class=\"moverName\">No shocks</span><span class=\"moverPct is-flat\">—</span></div>";
          return;
        }
        el.innerHTML = rows.map((row) => {
          const pctClass = pctDirClass(row.pct);
          return `
            <div class="moverRow is-shock ${pctClass}">
              <span class="moverSym">${row.sym}</span>
              <span class="moverName">${row.name}</span>
              <span class="moverPct ${pctClass}">${fmtPct(row.pct)}</span>
            </div>
          `;
        }).join("");
      }

      function updateMoverLists(items) {
        if (!Array.isArray(items)) return;
        const usable = items
          .map((it) => ({
            sym: String(it.sym ?? "").toUpperCase(),
            name: String(it.name ?? it.sym ?? ""),
            pct: Number(it.deltaPct),
          }))
          .filter((it) => it.sym && Number.isFinite(it.pct));

        const gainers = [...usable].sort((a, b) => b.pct - a.pct).slice(0, 5);
        const losers = [...usable].sort((a, b) => a.pct - b.pct).slice(0, 5);
        const vol = [...usable].sort((a, b) => Math.abs(b.pct) - Math.abs(a.pct)).slice(0, 5);
        const shockThreshold = 2;
        const shocks = [...usable]
          .filter((it) => Math.abs(it.pct) >= shockThreshold)
          .sort((a, b) => Math.abs(b.pct) - Math.abs(a.pct))
          .slice(0, 5);

        renderMoverList(gainersList, gainers);
        renderMoverList(losersList, losers);
        renderMoverList(volList, vol);
        renderShockList(shockList, shocks);
      }

      function escapeHtml(value) {
        return String(value ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function renderNews(items) {
        if (!newsTrack || !newsTrackClone) return;
        const cleaned = Array.isArray(items)
          ? items
              .map((it) => ({
                title: String(it?.title ?? "").trim(),
                link: String(it?.link ?? "").trim(),
                pubDate: String(it?.pubDate ?? "").trim(),
              }))
              .filter((it) => it.title.length)
          : [];

        if (!cleaned.length) {
          const empty = "<span class=\"newsItem\"><span class=\"newsText\">No headlines</span></span>";
          newsTrack.innerHTML = empty;
          newsTrackClone.innerHTML = empty;
          return;
        }

        const html = cleaned
          .map((it) => {
            const title = escapeHtml(it.title);
            const link = it.link ? escapeHtml(it.link) : "";
            const tags = headlineTagsFor(it.title)
              .map((tag) => `<span class="newsTag ${tag.hot ? "is-hot" : ""}">${escapeHtml(tag.label)}</span>`)
              .join("");
            const tagHtml = tags ? `<span class="newsTags">${tags}</span>` : "";
            const dateAttr = it.pubDate ? ` title="${escapeHtml(it.pubDate)}"` : "";
            return link
              ? `<a class="newsItem" href="${link}" target="_blank" rel="noopener noreferrer"${dateAttr}>${tagHtml}<span class="newsText">${title}</span></a>`
              : `<span class="newsItem"${dateAttr}>${tagHtml}<span class="newsText">${title}</span></span>`;
          })
          .join("");

        newsTrack.innerHTML = html;
        newsTrackClone.innerHTML = html;
      }

      async function loadNews() {
        if (!newsTrack || !newsTrackClone) return;
        try {
          const res = await fetch(`data/news.json?v=${Date.now()}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          renderNews(payload?.items ?? []);
        } catch {
          // Keep placeholder text on failure.
        }
      }

      /**
       * Compute a match score for sorting.
       * Higher score = closer match.
       *
       * @param {any} it
       * @param {string[]} tokens
       * @returns {number}
       */
      function scoreItem(it, tokens) {
        if (!tokens.length) return 0;

        const sym = String(it?.sym ?? "").trim().toLowerCase();
        const name = String(it?.name ?? "").trim().toLowerCase();
        const group = String(it?.group ?? "").trim().toLowerCase();

        let score = 0;
        for (const t of tokens) {
          if (!t) continue;

          // Symbol: strongest signal
          if (sym === t) score += 40;
          else if (sym.startsWith(t)) score += 25;
          else if (sym.includes(t)) score += 12;

          // Name: medium signal
          if (name === t) score += 18;
          else if (name.startsWith(t)) score += 12;
          else if (name.includes(t)) score += 8;

          // Group: lighter signal (index/mega/sector/etc.)
          if (group === t) score += 10;
          else if (group.startsWith(t)) score += 7;
          else if (group.includes(t)) score += 4;
        }

        return score;
      }

      function sizeTile(tile, pct) {
        if (!hmSizeMode) {
          tile.style.gridColumnEnd = "";
          tile.style.gridRowEnd = "";
          return;
        }
        const absPct = Math.abs(pct);
        let rowSpan = 1;
        if (Number.isFinite(absPct)) {
          if (absPct >= 5) rowSpan = 3;
          else if (absPct >= 2.5) rowSpan = 2;
        }
        tile.style.gridColumnEnd = "span 1";
        tile.style.gridRowEnd = `span ${rowSpan}`;
      }

      function buildTile(it) {
        const pct = Number(it.deltaPct);
        const close = Number(it.close);

        const tile = document.createElement("button");
        tile.type = "button";
        tile.className = `hmTile ${bandClass(pct)}`;
        tile.setAttribute("role", "listitem");
        tile.title = it.ok === false ? `Failed: ${it.error ?? "unknown"}` : "Open on Stooq";

        const symLabel = String(it.sym ?? "").toUpperCase();
        const group = it.group ? String(it.group) : "";
        const groupKey = group ? group.toLowerCase() : "";
        if (groupKey) tile.dataset.group = groupKey;
        const dateText = fmtDateShort(it.date);
        const prevClose = Number(it.prevClose);
        const prevText = Number.isFinite(prevClose) ? formatValueBySym(it.sym, prevClose) : "—";
        const tipText = it.ok === false ? "No data" : `Close ${dateText} · Prev ${prevText}`;

        sizeTile(tile, pct);

        tile.innerHTML = `
          <div class="hmSym">${symLabel}</div>
          <div class="hmName">${it.name ?? symLabel}</div>
          ${group ? `<div class="hmTag">${group}</div>` : ""}
          <div class="hmNums">
            <div class="hmPct ${it.ok === false ? "" : pctDirClass(pct)}">${it.ok === false ? "—" : fmtPct(pct)}</div>
            <div class="hmPx">${it.ok === false ? "" : formatValueBySym(it.sym, close)}</div>
          </div>
          <div class="hmTip">${tipText}</div>
        `;

        tile.addEventListener("click", () => {
          const sym = encodeURIComponent(it.sym ?? "");
          if (!sym) return;
          window.open(`https://stooq.com/q/?s=${sym}`, "_blank", "noopener,noreferrer");
        });

        return tile;
      }

      /**
       * Render heatmap tiles.
       * @param {Array<any>} items
       * @param {string|null} generatedAt
       */
      function renderTiles(items, generatedAt) {
        grid.classList.remove("is-grouped");
        updateSizeModeClasses();
        grid.innerHTML = "";

        for (const it of items) {
          grid.appendChild(buildTile(it));
        }

        const ts = generatedAt ? new Date(generatedAt) : null;
        stamp.textContent = ts && !Number.isNaN(ts.getTime())
          ? `Updated: ${ts.toLocaleString()}`
          : "Updated: —";
      }

      /**
       * Render grouped heatmap tiles.
       * @param {Array<{key:string,label:string,items:Array<any>}>} groups
       * @param {string|null} generatedAt
       */
      function renderGroupedTiles(groups, generatedAt) {
        grid.classList.add("is-grouped");
        updateSizeModeClasses();
        grid.innerHTML = "";

        for (const group of groups) {
          const items = Array.isArray(group.items) ? group.items : [];
          if (!items.length) continue;

          const card = document.createElement("div");
          card.className = "hmGroup";
          card.innerHTML = `
            <div class="hmGroupHead">
              <div class="hmGroupTitle">${group.label}</div>
              <div class="hmGroupCount">${items.length} items</div>
            </div>
            <div class="hmGroupGrid${hmSizeMode ? " is-sized" : ""}"></div>
          `;

          const inner = card.querySelector(".hmGroupGrid");
          if (inner) {
            for (const it of items) {
              inner.appendChild(buildTile(it));
            }
          }

          grid.appendChild(card);
        }

        const ts = generatedAt ? new Date(generatedAt) : null;
        stamp.textContent = ts && !Number.isNaN(ts.getTime())
          ? `Updated: ${ts.toLocaleString()}`
          : "Updated: —";
      }

      /**
       * Apply the current query: sort items by symbol/name/group match.
       * We don't hide non-matches; we just push matches to the front.
       */
      function applyHeatmapQuery() {
        const q = getHeatmapQuery().toLowerCase();
        const tokens = q.split(/\s+/g).filter(Boolean);

        const base = Array.isArray(hmState.baseItems) ? hmState.baseItems : [];
        if (!base.length) {
          renderTiles([], hmState.generatedAt);
          return;
        }

        const filtered = hmGroup === "all"
          ? base
          : base.filter((it) => groupKeyFor(it) === hmGroup);

        if (!filtered.length) {
          renderTiles([], hmState.generatedAt);
          return;
        }

        if (hmGroup === "all") {
          const groups = hmGroupOrder.map((g) => ({
            key: g.key,
            label: g.label,
            items: sortItems(filtered.filter((it) => groupKeyFor(it) === g.key), tokens),
          }));
          renderGroupedTiles(groups, hmState.generatedAt);
          return;
        }

        renderTiles(sortItems(filtered, tokens), hmState.generatedAt);
      }

      /**
       * Render heatmap from payload and preserve base ordering for stable re-sorts.
       * @param {{generatedAt:string, items:Array<any>}} payload
       */
      function render(payload) {
        const items = Array.isArray(payload?.items) ? payload.items : [];
        hmState.baseItems = items;
        hmState.generatedAt = payload?.generatedAt ?? null;
        applyHeatmapQuery();
        updateSymbolBindings(items);
        updateSignalBlocks(items);
        updateMoverLists(items);
        renderAlertConsole(items);
        renderCorrelationMatrix(items);
        updateTermSync(hmState.generatedAt);
      }

      /**
       * Fetch heatmap.json from the same origin.
       */
      async function load() {
        grid.innerHTML = "";
        const skeleton = document.createElement("div");
        skeleton.className = "muted";
        skeleton.textContent = "Loading heatmap…";
        grid.appendChild(skeleton);

        try {
          const res = await fetch(`heatmap.json?v=${Date.now()}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          render(payload);
        } catch (e) {
          grid.innerHTML = "";
          const err = document.createElement("div");
          err.className = "muted";
          err.textContent = `Heatmap failed to load (${e instanceof Error ? e.message : String(e)}).`;
          grid.appendChild(err);
        }
      }

      btn.addEventListener("click", load);

      // Re-sort heatmap as the user types in the main search box.
      if (searchInput) {
        searchInput.addEventListener("input", () => {
          // If heatmap hasn't loaded yet, this is harmless.
          applyHeatmapQuery();
        });
      }

      updateClocks();
      setInterval(updateClocks, 1000);
      load();
      loadNews();
    })();
  </script>
</body>
</html>
